<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrazione Artista - RECORP ALL-IN-ONE</title>
    <link rel="stylesheet" href="./assets/style.css">
    <style>
        /* Stili specifici per registrazione */
        .registration-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-section {
            background: var(--light);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-section h3 {
            margin-bottom: 1rem;
            color: var(--primary);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .privacy-box {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            height: 200px;
            overflow-y: auto;
            margin: 1rem 0;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .privacy-box h4 {
            margin-bottom: 0.5rem;
            color: var(--dark);
        }

        .btn-group {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        .error-message {
            color: var(--danger);
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: none;
        }

        .form-control.error {
            border-color: var(--danger);
        }

        select.form-control {
            cursor: pointer;
        }

        .radio-group {
            display: flex;
            gap: 2rem;
            margin-top: 0.5rem;
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .success-message {
            background: #d1fae5;
            border: 1px solid #34d399;
            color: #065f46;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }

        /* Autocomplete dropdown per citt√† */
        .autocomplete-dropdown {
            position: absolute;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            width: 100%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            border-top: none;
            margin-top: -1px;
        }
        
        .autocomplete-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            transition: all 0.2s ease;
        }
        
        .autocomplete-item:hover {
            background: #f8fafc;
            border-left: 3px solid var(--primary);
        }
        
        .autocomplete-item:last-child {
            border-bottom: none;
            border-radius: 0 0 8px 8px;
        }
        
        .autocomplete-item strong {
            color: var(--dark);
            font-weight: 600;
        }
        
        .autocomplete-item small {
            color: #6b7280;
            font-size: 0.875rem;
        }
        
        .autocomplete-header {
            padding: 8px 16px;
            background: #f3f4f6;
            font-weight: bold;
            color: #6b7280;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .autocomplete-loading {
            padding: 12px 16px;
            text-align: center;
            color: #6b7280;
            font-style: italic;
        }
        
        .autocomplete-no-results {
            padding: 12px 16px;
            text-align: center;
            color: #6b7280;
            font-style: italic;
        }

        /* Validazione campi localit√† */
        .form-control.valid {
            border-color: #10b981 !important;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%2310b981' d='m2.3 6.73.4.4L7.5 2.4l-.5-.5L3.7 5.2 1.5 3l-.5.5 1.3 1.23z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px 16px;
            padding-right: 40px;
        }
        
        .form-control.invalid {
            border-color: #ef4444 !important;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23ef4444'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m6 3v3m0 3h.01'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px 16px;
            padding-right: 40px;
        }
        
        .province-badge {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 4px;
        }
        
        .highlight {
            background-color: #fef3c7;
            font-weight: 600;
            padding: 1px 2px;
            border-radius: 2px;
        }
        
        .location-helper-text {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 4px;
        }

        /* Alert messages */
        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #34d399;
        }
        
        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #f87171;
        }
        
        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fbbf24;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="registration-container">
            <!-- Header -->
            <div class="header">
                <h1>Registrazione Nuovo Artista</h1>
                <p>Inserisci i dati dell'artista per la registrazione nel sistema</p>
            </div>

            <!-- Success Message -->
            <div class="success-message" id="successMessage">
                ‚úÖ Artista registrato con successo! Verrai reindirizzato alla homepage...
            </div>

            <!-- Form -->
            <form id="registrationForm" onsubmit="submitForm(event)">
                <!-- Dati Anagrafici -->
                <div class="form-section">
                    <h3>üìã Dati Anagrafici</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Codice Fiscale *</label>
                            <input type="text" class="form-control" id="cf" name="cf" maxlength="16" required 
                                   placeholder="RSSMRA85M01H501Z" onblur="validateCF()" oninput="extractDataFromCF()">
                            <span class="error-message" id="cfError">Codice fiscale non valido</span>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nome *</label>
                            <input type="text" class="form-control" id="nome" name="nome" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Cognome *</label>
                            <input type="text" class="form-control" id="cognome" name="cognome" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Data di Nascita *</label>
                            <input type="date" class="form-control" id="dataNascita" name="dataNascita" required
                                   max="" onchange="validateAge(); checkDateCFMatch();">
                            <span class="error-message" id="ageError">Devi essere maggiorenne per registrarti</span>
                            <span class="error-message" id="dateMatchError">La data di nascita non corrisponde al codice fiscale</span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nome d'Arte</label>
                            <input type="text" class="form-control" id="nomeArte" name="nomeArte" 
                                   placeholder="Opzionale">
                        </div>
                    </div>
                </div>

                <!-- Indirizzo con Autocomplete -->
                <div class="form-section">
                    <h3>üìç Indirizzo</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Via/Piazza *</label>
                            <input type="text" class="form-control" id="via" name="via" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="position: relative;">
                            <label class="form-label">Citt√† *</label>
                            <input type="text" class="form-control" id="citta" name="citta" required>
                            <div class="location-helper-text">Inizia a digitare per cercare la citt√†</div>
                        </div>
                        <div class="form-group" style="position: relative;">
                            <label class="form-label">CAP *</label>
                            <input type="text" class="form-control" id="cap" name="cap" 
                                   pattern="[0-9]{5}" maxlength="5" required placeholder="00100">
                            <div class="location-helper-text">Inserisci il CAP a 5 cifre</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Provincia *</label>
                            <input type="text" class="form-control" id="provincia" name="provincia" 
                                   maxlength="2" required placeholder="RM" style="text-transform: uppercase;">
                            <div class="location-helper-text">Codice provincia (es: VI, VE, PD)</div>
                        </div>
                    </div>
                </div>

                <!-- Dati Professionali -->
                <div class="form-section">
                    <h3>üíº Dati Professionali</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Partita IVA *</label>
                            <div class="radio-group">
                                <label class="radio-label">
                                    <input type="radio" name="piva" value="si" required> S√¨
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="piva" value="no" required> No
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Mansione *</label>
                            <select class="form-control" id="mansione" name="mansione" required>
                                <option value="">Seleziona...</option>
                                <option value="DJ">DJ (032)</option>
                                <option value="Vocalist">Vocalist (031)</option>
                                <option value="Ballerino/a">Ballerino/a (092)</option>
                                <option value="Tecnico">Tecnico (117)</option>
                                <option value="Fotografo">Fotografo (126)</option>
                                <option value="Truccatore">Truccatore (141)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Dati Bancari e Contatti -->
                <div class="form-section">
                    <h3>üí≥ Dati Bancari e Contatti</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">IBAN *</label>
                            <input type="text" class="form-control" id="iban" name="iban" 
                                   maxlength="27" required placeholder="IT60X0542811101000000123456"
                                   onblur="validateIBAN()">
                            <span class="error-message" id="ibanError">IBAN non valido</span>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Email *</label>
                            <input type="email" class="form-control" id="email" name="email" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Cellulare *</label>
                            <input type="tel" class="form-control" id="telefono" name="telefono" 
                                   pattern="[0-9]{9,10}" required placeholder="3331234567">
                        </div>
                    </div>
                </div>

                <!-- Privacy -->
                <div class="form-section">
                    <h3>üîí Privacy e Consensi</h3>
                    <div class="privacy-box">
                        <h4>Informativa sulla Privacy - RECORP ALL-IN-ONE</h4>
                        <p><strong>1. Titolare del Trattamento</strong><br>
                        RECORP S.r.l., con sede legale in [indirizzo], P.IVA 04433920248</p>
                        
                        <p><strong>2. Finalit√† del Trattamento</strong><br>
                        I dati personali forniti saranno trattati per:
                        <br>‚Ä¢ Gestione delle pratiche di agibilit√† ex-ENPALS
                        <br>‚Ä¢ Adempimenti fiscali e contributivi obbligatori
                        <br>‚Ä¢ Gestione dei pagamenti e della fatturazione
                        <br>‚Ä¢ Comunicazioni relative alle prestazioni lavorative</p>
                        
                        <p><strong>3. Base Giuridica</strong><br>
                        Il trattamento √® necessario per l'esecuzione di un contratto e per adempiere agli obblighi legali previsti dalla normativa fiscale e previdenziale.</p>
                        
                        <p><strong>4. Conservazione dei Dati</strong><br>
                        I dati saranno conservati per 10 anni dalla cessazione del rapporto, come previsto dalla normativa fiscale.</p>
                        
                        <p><strong>5. Diritti dell'Interessato</strong><br>
                        L'interessato ha diritto di accesso, rettifica, cancellazione, limitazione del trattamento e portabilit√† dei dati, nonch√© di opposizione al trattamento.</p>
                        
                        <p><strong>6. Comunicazione dei Dati</strong><br>
                        I dati potranno essere comunicati a:
                        <br>‚Ä¢ INPS per gli adempimenti contributivi
                        <br>‚Ä¢ Agenzia delle Entrate per gli adempimenti fiscali
                        <br>‚Ä¢ Istituti bancari per la gestione dei pagamenti
                        <br>‚Ä¢ Consulenti fiscali e del lavoro</p>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="privacy" name="privacy" required>
                        <label for="privacy">
                            Ho letto e accetto l'informativa sulla privacy *
                        </label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="marketing" name="marketing">
                        <label for="marketing">
                            Acconsento all'invio di comunicazioni promozionali (facoltativo)
                        </label>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">
                        üíæ Registra Artista
                    </button>
                    <a href="./index.html" class="btn btn-secondary">
                        ‚ùå Annulla
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="comuni-loader.js"></script>
    <script>
        // Variabili globali
        let cfExtractedDate = null;

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            // Inizializza database GI
            if (typeof window.GIDatabase !== 'undefined') {
                window.GIDatabase.init().then(() => {
                    console.log('‚úÖ Database GI inizializzato per registrazione');
                    setupLocationAutocomplete();
                });
            } else {
                console.warn('‚ö†Ô∏è Database GI non disponibile');
                setupLocationAutocomplete();
            }

            // Set max date for birth date (18 years ago)
            const today = new Date();
            const maxDate = new Date(today.getFullYear() - 18, today.getMonth(), today.getDate());
            document.getElementById('dataNascita').max = maxDate.toISOString().split('T')[0];

            // Auto uppercase per alcuni campi
            document.getElementById('cf').addEventListener('input', function() {
                this.value = this.value.toUpperCase();
            });
            
            document.getElementById('provincia').addEventListener('input', function() {
                this.value = this.value.toUpperCase();
            });
            
            document.getElementById('iban').addEventListener('input', function() {
                this.value = this.value.toUpperCase();
            });

            // Event listeners per chiudere dropdown
            document.addEventListener('click', function(event) {
                if (!event.target.closest('#citta') && !event.target.closest('#cityAutocompleteDropdown')) {
                    hideCityAutocomplete();
                }
                
                if (!event.target.closest('#cap') && !event.target.closest('#capMultipleDropdown')) {
                    hideMultipleDropdowns();
                }
            });
        });

        // SETUP AUTOCOMPLETE LOCALIT√Ä
        function setupLocationAutocomplete() {
            const cittaInput = document.getElementById('citta');
            const capInput = document.getElementById('cap');
            const provinciaInput = document.getElementById('provincia');
            
            if (!cittaInput || !capInput || !provinciaInput) {
                console.warn('‚ö†Ô∏è Campi localit√† non trovati');
                return;
            }
            
            // Autocomplete citt√†
            cittaInput.addEventListener('input', function() {
                showCityAutocompleteGI(this.value);
            });
            
            // Autocomplete CAP
            capInput.addEventListener('input', function() {
                if (this.value.length === 5) {
                    autoFillFromCAPGI(this.value);
                } else if (this.value.length === 0) {
                    resetLocationValidation();
                }
            });
            
            // Validazione provincia
            provinciaInput.addEventListener('change', function() {
                validateProvinciaAndCAPGI();
            });
        }

        // Mostra autocomplete citt√† con database GI
        function showCityAutocompleteGI(searchTerm) {
            if (searchTerm.length < 2) {
                hideCityAutocomplete();
                return;
            }
            
            if (!window.GIDatabase || !window.GIDatabase.isLoaded()) {
                showLoadingInAutocomplete();
                return;
            }
            
            const results = window.GIDatabase.searchComuni(searchTerm);
            
            if (results.length === 0) {
                showNoResultsInAutocomplete();
                return;
            }
            
            let dropdown = document.getElementById('cityAutocompleteDropdown');
            if (!dropdown) {
                dropdown = createAutocompleteDropdown('cityAutocompleteDropdown', 'citta');
            }
            
            dropdown.innerHTML = results.map(comune => {
                const highlighted = highlightSearchTerm(comune.nome, searchTerm);
                return `
                    <div class="autocomplete-item" onclick="selectCityGI('${comune.nome}', '${comune.cap || ''}', '${comune.provincia}', '${comune.codice}')">
                        <strong>${highlighted}</strong>
                        <span class="province-badge">${comune.provincia}</span><br>
                        <small>CAP: ${comune.cap || 'N/D'} - ${getProvinciaNameByCode(comune.provincia)}</small>
                    </div>
                `;
            }).join('');
            
            dropdown.style.display = 'block';
        }

        // Auto-riempimento da CAP
        function autoFillFromCAPGI(cap) {
            if (!window.GIDatabase || !window.GIDatabase.isLoaded()) {
                showCAPError('Database non caricato');
                return;
            }
            
            const results = window.GIDatabase.searchByCAP(cap);
            
            if (results.length === 0) {
                showCAPError('CAP non trovato');
                return;
            }
            
            if (results.length === 1) {
                const result = results[0];
                const comune = window.GIDatabase.getComuneByCodice(result.comune);
                
                if (comune) {
                    document.getElementById('citta').value = comune.nome;
                    document.getElementById('provincia').value = comune.provincia;
                    document.getElementById('citta').dataset.codiceIstat = comune.codice;
                    
                    validateLocationDataGI();
                }
            } else {
                showCAPMultipleResultsGI(results);
            }
        }

        // Mostra risultati multipli per CAP
        function showCAPMultipleResultsGI(results) {
            let dropdown = document.getElementById('capMultipleDropdown');
            if (!dropdown) {
                dropdown = createAutocompleteDropdown('capMultipleDropdown', 'cap');
            }
            
            dropdown.innerHTML = `
                <div class="autocomplete-header">
                    Pi√π comuni con questo CAP:
                </div>
                ${results.map(result => {
                    const comune = window.GIDatabase.getComuneByCodice(result.comune);
                    if (!comune) return '';
                    
                    return `
                        <div class="autocomplete-item" onclick="selectCityGI('${comune.nome}', '${result.cap}', '${comune.provincia}', '${comune.codice}')">
                            <strong>${comune.nome}</strong>
                            <span class="province-badge">${comune.provincia}</span><br>
                            <small>${getProvinciaNameByCode(comune.provincia)}</small>
                        </div>
                    `;
                }).join('')}
            `;
            
            dropdown.style.display = 'block';
            
            setTimeout(() => {
                if (dropdown) dropdown.style.display = 'none';
            }, 15000);
        }

        // Seleziona citt√† dall'autocomplete
        function selectCityGI(nome, cap, provincia, codiceIstat) {
            document.getElementById('citta').value = nome;
            document.getElementById('cap').value = cap;
            document.getElementById('provincia').value = provincia;
            
            document.getElementById('citta').dataset.codiceIstat = codiceIstat;
            
            hideCityAutocomplete();
            hideMultipleDropdowns();
            
            validateLocationDataGI();
        }

        // Valida dati localit√†
        function validateLocationDataGI() {
            const citta = document.getElementById('citta').value;
            const cap = document.getElementById('cap').value;
            const provincia = document.getElementById('provincia').value;
            
            if (!citta || !cap || !provincia) return;
            
            if (!window.GIDatabase || !window.GIDatabase.isLoaded()) {
                return;
            }
            
            const isValid = window.GIDatabase.validateCAP(cap, provincia);
            
            if (isValid) {
                setFieldValidation('citta', true);
                setFieldValidation('cap', true);
                setFieldValidation('provincia', true);
                
                showValidationMessage('‚úÖ Dati localit√† validati', 'success');
            } else {
                setFieldValidation('cap', false);
                showValidationMessage('‚ö†Ô∏è CAP e provincia potrebbero non essere coerenti', 'warning');
            }
        }

        function validateProvinciaAndCAPGI() {
            validateLocationDataGI();
        }

        // Ottieni nome provincia da codice
        function getProvinciaNameByCode(codice) {
            if (!window.GIDatabase || !window.GIDatabase.isLoaded()) {
                return codice;
            }
            
            const provincia = window.GIDatabase.getProvinciaByCode(codice);
            return provincia ? provincia.nome : codice;
        }

        // FUNZIONI UTILIT√Ä UI
        function createAutocompleteDropdown(id, parentInputId) {
            const dropdown = document.createElement('div');
            dropdown.id = id;
            dropdown.className = 'autocomplete-dropdown';
            
            const parentInput = document.getElementById(parentInputId);
            parentInput.parentNode.style.position = 'relative';
            parentInput.parentNode.appendChild(dropdown);
            
            return dropdown;
        }

        function highlightSearchTerm(text, searchTerm) {
            if (!searchTerm) return text;
            
            const regex = new RegExp(`(${escapeRegExp(searchTerm)})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function showLoadingInAutocomplete() {
            let dropdown = document.getElementById('cityAutocompleteDropdown');
            if (!dropdown) {
                dropdown = createAutocompleteDropdown('cityAutocompleteDropdown', 'citta');
            }
            
            dropdown.innerHTML = '<div class="autocomplete-loading">Caricamento database...</div>';
            dropdown.style.display = 'block';
        }

        function showNoResultsInAutocomplete() {
            let dropdown = document.getElementById('cityAutocompleteDropdown');
            if (!dropdown) {
                dropdown = createAutocompleteDropdown('cityAutocompleteDropdown', 'citta');
            }
            
            dropdown.innerHTML = '<div class="autocomplete-no-results">Nessun comune trovato</div>';
            dropdown.style.display = 'block';
        }

        function hideCityAutocomplete() {
            const dropdown = document.getElementById('cityAutocompleteDropdown');
            if (dropdown) {
                dropdown.style.display = 'none';
            }
        }

        function hideMultipleDropdowns() {
            const dropdowns = ['capMultipleDropdown'];
            dropdowns.forEach(id => {
                const dropdown = document.getElementById(id);
                if (dropdown) {
                    dropdown.style.display = 'none';
                }
            });
        }

        function setFieldValidation(fieldId, isValid) {
            const field = document.getElementById(fieldId);
            if (!field) return;
            
            field.classList.remove('valid', 'invalid');
            field.classList.add(isValid ? 'valid' : 'invalid');
        }

        function showValidationMessage(message, type) {
            const existing = document.querySelectorAll('.validation-message');
            existing.forEach(msg => msg.remove());
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `alert alert-${type} validation-message`;
            messageDiv.textContent = message;
            
            const provinciaInput = document.getElementById('provincia');
            provinciaInput.parentNode.appendChild(messageDiv);
            
            setTimeout(() => messageDiv.remove(), 3000);
        }

        function showCAPError(message) {
            const capInput = document.getElementById('cap');
            setFieldValidation('cap', false);
            
            showValidationMessage(`‚ùå ${message}`, 'error');
        }

        function resetLocationValidation() {
            ['citta', 'cap', 'provincia'].forEach(id => {
                const field = document.getElementById(id);
                if (field) {
                    field.classList.remove('valid', 'invalid');
                    field.style.borderColor = '';
                }
            });
            
            const messages = document.querySelectorAll('.validation-message');
            messages.forEach(msg => msg.remove());
        }

        // VALIDAZIONI ORIGINALI
        function validateAge() {
            const today = new Date();
            const birthDate = new Date(document.getElementById('dataNascita').value);
            const age = Math.floor((today - birthDate) / (365.25 * 24 * 60 * 60 * 1000));
            
            if (age < 18) {
                document.getElementById('dataNascita').classList.add('error');
                document.getElementById('ageError').style.display = 'block';
                return false;
            } else {
                document.getElementById('dataNascita').classList.remove('error');
                document.getElementById('ageError').style.display = 'none';
                return true;
            }
        }

        function extractDataFromCF() {
            const cf = document.getElementById('cf').value.toUpperCase();
            
            if (cf.length === 16) {
                const year = cf.substring(6, 8);
                const monthLetter = cf.substring(8, 9);
                const day = cf.substring(9, 11);
                
                const months = {
                    'A': '01', 'B': '02', 'C': '03', 'D': '04',
                    'E': '05', 'H': '06', 'L': '07', 'M': '08',
                    'P': '09', 'R': '10', 'S': '11', 'T': '12'
                };
                
                const month = months[monthLetter];
                if (month) {
                    const yearInt = parseInt(year);
                    const currentYear = new Date().getFullYear();
                    const currentYearShort = currentYear % 100;
                    
                    let fullYear;
                    if (yearInt <= currentYearShort && yearInt <= 40) {
                        fullYear = '20' + year;
                    } else {
                        fullYear = '19' + year;
                    }
                    
                    const dayInt = parseInt(day);
                    const actualDay = dayInt > 40 ? dayInt - 40 : dayInt;
                    const formattedDay = actualDay.toString().padStart(2, '0');
                    
                    const birthDate = `${fullYear}-${month}-${formattedDay}`;
                    cfExtractedDate = birthDate;
                    document.getElementById('dataNascita').value = birthDate;
                    
                    const birthDateObj = new Date(birthDate);
                    const today = new Date();
                    let age = today.getFullYear() - birthDateObj.getFullYear();
                    const monthDiff = today.getMonth() - birthDateObj.getMonth();
                    
                    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDateObj.getDate())) {
                        age--;
                    }
                    
                    if (age < 18) {
                        alert('‚ö†Ô∏è ATTENZIONE: Il soggetto risulta minorenne.\n\nNon √® possibile procedere con la registrazione.\nSolo i maggiorenni possono essere registrati nel sistema.');
                        document.getElementById('cf').value = '';
                        document.getElementById('dataNascita').value = '';
                        cfExtractedDate = null;
                    }
                }
            }
        }

        function checkDateCFMatch() {
            if (!cfExtractedDate) return true;
            
            const manualDate = document.getElementById('dataNascita').value;
            
            if (manualDate !== cfExtractedDate) {
                document.getElementById('dataNascita').classList.add('error');
                document.getElementById('dateMatchError').style.display = 'block';
                return false;
            } else {
                document.getElementById('dataNascita').classList.remove('error');
                document.getElementById('dateMatchError').style.display = 'none';
                return true;
            }
        }

        function validateCF() {
            const cf = document.getElementById('cf').value.toUpperCase();
            const cfRegex = /^[A-Z]{6}[0-9]{2}[A-Z][0-9]{2}[A-Z][0-9]{3}[A-Z]$/;
            
            if (cf && !cfRegex.test(cf)) {
                document.getElementById('cf').classList.add('error');
                document.getElementById('cfError').style.display = 'block';
                return false;
            } else {
                document.getElementById('cf').classList.remove('error');
                document.getElementById('cfError').style.display = 'none';
                return true;
            }
        }

        function validateIBAN() {
            const iban = document.getElementById('iban').value.toUpperCase().replace(/\s/g, '');
            const ibanRegex = /^IT[0-9]{2}[A-Z][0-9]{22}$/;
            
            if (iban && !ibanRegex.test(iban)) {
                document.getElementById('iban').classList.add('error');
                document.getElementById('ibanError').style.display = 'block';
                return false;
            } else {
                document.getElementById('iban').classList.remove('error');
                document.getElementById('ibanError').style.display = 'none';
                return true;
            }
        }

        // SUBMIT FORM
        function submitForm(event) {
            event.preventDefault();
            
            if (!validateAge() || !validateCF() || !validateIBAN() || !checkDateCFMatch()) {
                alert('Correggi gli errori nel form prima di procedere');
                return;
            }

            const formData = new FormData(event.target);
            const artistData = {
                id: Date.now(),
                cf: formData.get('cf').toUpperCase(),
                nome: formData.get('nome'),
                cognome: formData.get('cognome'),
                dataNascita: formData.get('dataNascita'),
                nomeArte: formData.get('nomeArte'),
                via: formData.get('via'),
                citta: formData.get('citta'),
                provincia: formData.get('provincia').toUpperCase(),
                cap: formData.get('cap'),
                piva: formData.get('piva') === 'si',
                mansione: formData.get('mansione'),
                iban: formData.get('iban').toUpperCase(),
                email: formData.get('email'),
                telefono: formData.get('telefono'),
                privacy: formData.get('privacy') === 'on',
                marketing: formData.get('marketing') === 'on',
                agibilita: [],
                // Salva codice ISTAT se disponibile
                codiceIstatNascita: document.getElementById('citta').dataset.codiceIstat || null
            };

            let artistsDB = JSON.parse(localStorage.getItem('artistsDB')) || [];
            
            if (artistsDB.some(a => a.cf === artistData.cf)) {
                alert('Esiste gi√† un artista con questo codice fiscale!');
                return;
            }

            artistsDB.push(artistData);
            localStorage.setItem('artistsDB', JSON.stringify(artistsDB));

            if (sessionStorage.getItem('returnToAgibilita')) {
                sessionStorage.removeItem('returnToAgibilita');
                sessionStorage.setItem('newArtistId', artistData.id);
                
                document.getElementById('successMessage').innerHTML = 
                    '‚úÖ Artista registrato! Torno alla creazione agibilit√†...';
                document.getElementById('successMessage').style.display = 'block';
                document.getElementById('registrationForm').style.display = 'none';
                
                setTimeout(() => {
                    window.location.href = './agibilita/index.html';
                }, 1500);
            } else {
                document.getElementById('successMessage').style.display = 'block';
                document.getElementById('registrationForm').style.display = 'none';
                
                setTimeout(() => {
                    window.location.href = './index.html';
                }, 2000);
            }
        }
    </script>
</body>
</html>
