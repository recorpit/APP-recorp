<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RECORP ALL-IN-ONE - Sistema Gestionale</title>
    <link rel="stylesheet" href="./assets/style.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-content">
            <a href="./index.html" class="logo">
                <img src="./assets/logo.png" alt="RECORP Logo">
                <span class="logo-text">RECORP ALL-IN-ONE</span>
            </a>
            <div class="nav-links">
                <a href="./index.html" class="active">Dashboard</a>
                <a href="./registrazione-artista.html">Nuova Registrazione</a>
                <a href="./agibilita/index.html">Agibilit√†</a>
            </div>
        </div>
    </nav>

    <div class="page-container">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <h1>RECORP ALL-IN-ONE</h1>
                <p>Sistema integrato per la gestione artisti e agibilit√†</p>
            </div>

            <!-- Ricerca e Registrazione -->
            <div class="search-section">
                <div class="search-container">
                    <div class="search-input-wrapper">
                        <input type="text" class="search-input" id="searchInput" 
                               placeholder="Cerca artista per nome o codice fiscale..."
                               oninput="showSuggestions()" 
                               onblur="setTimeout(hideSuggestions, 200)"
                               autocomplete="off">
                        <div id="suggestions" class="suggestions-dropdown"></div>
                    </div>
                    <button class="btn btn-primary" onclick="searchArtist()">
                        üîç Cerca
                    </button>
                </div>
                <div class="search-register-link">
                    <a href="./registrazione-artista.html" class="btn btn-success">
                        ‚ûï Registra Nuovo Artista
                    </a>
                </div>
            </div>

            <!-- Azioni principali -->
            <div class="actions-grid">
                <div class="action-card" onclick="startNewAgibilita()">
                    <div class="action-icon">
                        <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                    </div>
                    <h3>Creazione Agibilit√†</h3>
                    <p>Crea nuove agibilit√† o modifica esistenti</p>
                </div>
                
                <div class="action-card" onclick="showComingSoon()">
                    <div class="action-icon">
                        <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                        </svg>
                    </div>
                    <h3>Comunicazione a Chiamata</h3>
                    <p>Gestisci il lavoro intermittente</p>
                </div>
                
                <div class="action-card" onclick="showComingSoon()">
                    <div class="action-icon">
                        <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="1" x2="12" y2="23"></line>
                            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                        </svg>
                    </div>
                    <h3>Gestione Fatturazione</h3>
                    <p>Fatture e documenti fiscali</p>
                </div>
                
                <div class="action-card" onclick="showComingSoon()">
                    <div class="action-icon">
                        <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                            <line x1="1" y1="10" x2="23" y2="10"></line>
                        </svg>
                    </div>
                    <h3>Gestione Pagamenti</h3>
                    <p>Traccia pagamenti e scadenze</p>
                </div>
            </div>

            <!-- Statistiche -->
            <div class="stats-section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalArtists">0</div>
                        <div class="stat-label">Artisti Registrati</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="monthlyAgibilita">0</div>
                        <div class="stat-label">Agibilit√† Questo Mese</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalCompensation">‚Ç¨0</div>
                        <div class="stat-label">Totale Compensi</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="completionRate">0%</div>
                        <div class="stat-label">Pratiche Completate</div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="footer">
                <p>RECORP ALL-IN-ONE ¬© 2025 - Sistema Gestionale Integrato</p>
            </div>
        </div>
    </div>

    <!-- Database Management Button -->
    <div class="db-manager-button">
        <button class="btn btn-secondary btn-sm" onclick="toggleDatabaseManager()">
            ‚öôÔ∏è Gestione DB
        </button>
    </div>

    <!-- Chat AI Button -->
    <div class="chat-ai-button">
        <button class="btn btn-primary btn-chat-ai" onclick="openChatAI()">
            <span class="chat-ai-icon">ü§ñ</span>
            <span>Assistente AI</span>
        </button>
    </div>

    <!-- Modal risultati ricerca -->
    <div class="modal" id="searchModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Risultati Ricerca</h2>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div class="search-results" id="searchResults">
                <!-- I risultati verranno inseriti qui -->
            </div>
        </div>
    </div>

    <!-- Database Manager Modal -->
    <div class="modal" id="databaseManagerModal">
        <div class="modal-content modal-content-wide">
            <div class="modal-header">
                <h2>Gestione Database</h2>
                <button class="close-modal" onclick="closeDatabaseManager()">&times;</button>
            </div>
            
            <div class="tabs">
                <button class="tab active" onclick="showDBTab('artisti')">Artisti</button>
                <button class="tab" onclick="showDBTab('locali')">Locali</button>
                <button class="tab" onclick="showDBTab('export')">Export/Import</button>
            </div>
            
            <!-- Tab Artisti -->
            <div id="dbTabArtisti" class="tab-content active">
                <div class="form-group">
                    <input type="text" class="form-control" id="dbSearchArtist" 
                           placeholder="Cerca artista..." oninput="filterDBArtists()">
                </div>
                <div class="db-table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>CF</th>
                                <th>Mansione</th>
                                <th class="text-center">Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="dbArtistsList"></tbody>
                    </table>
                    <p id="noArtistsMsg" class="no-data-msg">Nessun artista nel database</p>
                </div>
            </div>
            
            <!-- Tab Locali -->
            <div id="dbTabLocali" class="tab-content">
                <div class="form-group">
                    <input type="text" class="form-control" id="dbSearchVenue" 
                           placeholder="Cerca locale..." oninput="filterDBVenues()">
                </div>
                <div class="db-table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Citt√†</th>
                                <th>Indirizzo</th>
                                <th class="text-center">Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="dbVenuesList"></tbody>
                    </table>
                    <p id="noVenuesMsg" class="no-data-msg">Nessun locale nel database</p>
                </div>
            </div>
            
            <!-- Tab Export/Import -->
            <div id="dbTabExport" class="tab-content">
                <div class="form-section">
                    <h3 class="form-section-title">Export Database</h3>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="exportDatabase('artisti')">
                            üì• Export Artisti
                        </button>
                        <button class="btn btn-primary" onclick="exportDatabase('locali')">
                            üì• Export Locali
                        </button>
                        <button class="btn btn-primary" onclick="exportDatabase('all')">
                            üì• Export Completo
                        </button>
                    </div>
                </div>
                <div class="form-section">
                    <h3 class="form-section-title">Import Database</h3>
                    <input type="file" id="importFile" accept=".json" onchange="importDatabase(event)">
                    <p class="import-help-text">
                        Seleziona un file JSON esportato precedentemente
                    </p>
                </div>
            </div>
        </div>
    </div>

<!-- SOSTITUISCI la sezione <script> alla fine del file index.html con questo codice -->

<script type="module">
    // Import Supabase DatabaseService
    import { DatabaseService, testConnection } from './supabase-config.js';

    // Database - ora caricati da Supabase
    let artistsDB = [];
    let agibilitaDB = [];
    let venuesDB = [];

    // Inizializzazione al caricamento pagina
    document.addEventListener('DOMContentLoaded', async function() {
        console.log('üöÄ Inizializzazione sistema RECORP...');
        
        // Test connessione Supabase
        const connected = await testConnection();
        if (!connected) {
            alert('‚ö†Ô∏è Errore connessione database. Controlla la configurazione.');
            return;
        }

        // Carica dati da Supabase
        await loadDataFromSupabase();
        
        // Aggiorna statistiche
        updateStatistics();
    });

    // Funzione per caricare dati da Supabase
    async function loadDataFromSupabase() {
        try {
            console.log('üì• Caricamento dati da Supabase...');
            
            // Carica artisti
            artistsDB = await DatabaseService.getArtisti();
            console.log(`‚úÖ ${artistsDB.length} artisti caricati`);
            
            // Carica agibilit√†
            agibilitaDB = await DatabaseService.getAgibilita();
            console.log(`‚úÖ ${agibilitaDB.length} agibilit√† caricate`);
            
            // Carica venues
            venuesDB = await DatabaseService.getVenues();
            console.log(`‚úÖ ${venuesDB.length} venues caricati`);
            
        } catch (error) {
            console.error('‚ùå Errore caricamento dati:', error);
            alert('Errore nel caricamento dei dati: ' + error.message);
        }
    }

    // Update statistics usando Supabase
    async function updateStatistics() {
        try {
            const stats = await DatabaseService.getStats();
            
            // Aggiorna i display
            document.getElementById('totalArtists').textContent = stats.totalArtists;
            document.getElementById('monthlyAgibilita').textContent = stats.monthlyAgibilita;
            
            // Formatta compenso
            let compText = '‚Ç¨0';
            if (stats.totalCompensation >= 1000) {
                compText = '‚Ç¨' + (stats.totalCompensation / 1000).toFixed(1) + 'k';
            } else if (stats.totalCompensation > 0) {
                compText = '‚Ç¨' + stats.totalCompensation.toFixed(0);
            }
            document.getElementById('totalCompensation').textContent = compText;
            
            document.getElementById('completionRate').textContent = stats.completionRate + '%';
            
        } catch (error) {
            console.error('‚ùå Errore aggiornamento statistiche:', error);
            // Fallback a valori di default
            document.getElementById('totalArtists').textContent = artistsDB.length;
            document.getElementById('monthlyAgibilita').textContent = '0';
            document.getElementById('totalCompensation').textContent = '‚Ç¨0';
            document.getElementById('completionRate').textContent = '0%';
        }
    }

    // Funzione per nuova agibilit√†
    function startNewAgibilita() {
        window.location.href = './agibilita/index.html';
    }

    // Funzione di ricerca con Supabase
    async function searchArtist() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        
        if (!searchTerm) {
            alert('Inserisci un nome o codice fiscale per la ricerca');
            return;
        }

        try {
            // Cerca in Supabase invece che in array locale
            const results = await DatabaseService.searchArtisti(searchTerm);
            displaySearchResults(results, searchTerm);
        } catch (error) {
            console.error('‚ùå Errore ricerca:', error);
            alert('Errore durante la ricerca: ' + error.message);
        }
    }

    // Mostra risultati ricerca (modificata per usare nuova struttura dati)
    function displaySearchResults(results, searchTerm) {
        const modal = document.getElementById('searchModal');
        const resultsContainer = document.getElementById('searchResults');
        
        resultsContainer.innerHTML = '';

        if (results.length === 0) {
            resultsContainer.innerHTML = `
                <div class="result-card">
                    <p>Nessun artista trovato per "${searchTerm}"</p>
                    <button class="btn btn-primary" style="margin-top: 1rem" onclick="addNewArtist()">
                        + Aggiungi Nuovo Artista
                    </button>
                </div>
            `;
        } else {
            results.forEach(artist => {
                // Adatta i nomi dei campi dal database
                const displayName = `${artist.nome} ${artist.cognome}${artist.nome_arte ? ' - ' + artist.nome_arte : ''}`;
                
                // Find agibilit√† for this artist
                const artistAgibilita = agibilitaDB.filter(a => 
                    a.artisti && a.artisti.some(art => art.cf === artist.codice_fiscale)
                );
                
                const agibilitaHtml = artistAgibilita.length > 0 
                    ? `
                        <div class="agibilita-list">
                            <h4>Agibilit√† Recenti:</h4>
                            ${artistAgibilita.slice(-3).map(a => `
                                <div class="agibilita-item">
                                    <span>${new Date(a.data_inizio).toLocaleDateString('it-IT')} | ${a.locale.descrizione}</span>
                                    <span>‚Ç¨${a.artisti.find(art => art.cf === artist.codice_fiscale)?.compenso || 0}</span>
                                </div>
                            `).join('')}
                        </div>
                    `
                    : '<p class="no-agibilita-msg">Nessuna agibilit√† registrata</p>';

                resultsContainer.innerHTML += `
                    <div class="result-card">
                        <div class="result-header">
                            <div class="result-info">
                                <h3>${displayName}</h3>
                                <p>CF: ${artist.codice_fiscale} | Tel: ${artist.telefono || 'N/D'}</p>
                                <p class="artist-role">${artist.mansione}</p>
                            </div>
                            <div class="result-actions">
                                <button class="btn btn-primary btn-sm" onclick="createAgibilitaForArtist('${artist.id}')">
                                    Nuova Agibilit√†
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="createComunicazione('${artist.id}')">
                                    Comunicazione
                                </button>
                            </div>
                        </div>
                        ${agibilitaHtml}
                    </div>
                `;
            });
        }

        modal.style.display = 'block';
    }

    // Chiudi modal
    function closeModal() {
        document.getElementById('searchModal').style.display = 'none';
        document.getElementById('searchInput').value = '';
    }

    // Funzioni placeholder
    function showComingSoon() {
        alert('Funzionalit√† in arrivo! üöÄ');
    }

    function addNewArtist() {
        window.location.href = './registrazione-artista.html';
    }

    function createAgibilitaForArtist(artistId) {
        // Store artist ID for agibilit√† page
        sessionStorage.setItem('selectedArtistId', artistId);
        window.location.href = './agibilita/index.html';
    }

    function createComunicazione(artistId) {
        alert('Funzione comunicazione a chiamata in sviluppo');
    }

    // Show suggestions while typing - ora usa Supabase
    async function showSuggestions() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const suggestionsDiv = document.getElementById('suggestions');
        
        if (searchTerm.length < 2) {
            suggestionsDiv.style.display = 'none';
            return;
        }
        
        try {
            const matches = await DatabaseService.searchArtisti(searchTerm);
            
            if (matches.length === 0) {
                suggestionsDiv.innerHTML = '<div class="no-suggestions">Nessun artista trovato</div>';
                suggestionsDiv.style.display = 'block';
                return;
            }
            
            suggestionsDiv.innerHTML = matches.slice(0, 5).map(artist => {
                const displayName = `${artist.nome} ${artist.cognome}${artist.nome_arte ? ' - ' + artist.nome_arte : ''}`;
                const highlightedName = highlightMatch(displayName, searchTerm);
                
                return `
                    <div class="suggestion-item" onclick="selectArtist('${artist.id}')">
                        <div>${highlightedName}</div>
                        <div class="suggestion-info">${artist.mansione} | CF: ${artist.codice_fiscale}</div>
                    </div>
                `;
            }).join('');
            
            suggestionsDiv.style.display = 'block';
        } catch (error) {
            console.error('‚ùå Errore suggestions:', error);
            suggestionsDiv.style.display = 'none';
        }
    }
    
    // Highlight matching text
    function highlightMatch(text, searchTerm) {
        const regex = new RegExp(`(${searchTerm})`, 'gi');
        return text.replace(regex, '<strong class="highlight-match">$1</strong>');
    }
    
    // Hide suggestions
    function hideSuggestions() {
        document.getElementById('suggestions').style.display = 'none';
    }
    
    // Select artist from suggestions
    function selectArtist(artistId) {
        const artist = artistsDB.find(a => a.id == artistId);
        if (artist) {
            const results = [artist];
            displaySearchResults(results, artist.nome);
            hideSuggestions();
            document.getElementById('searchInput').value = '';
        }
    }

    // Gestione Enter nella ricerca
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchArtist();
        }
    });

    // Rendi le funzioni disponibili globalmente
    window.startNewAgibilita = startNewAgibilita;
    window.searchArtist = searchArtist;
    window.showSuggestions = showSuggestions;
    window.hideSuggestions = hideSuggestions;
    window.selectArtist = selectArtist;
    window.closeModal = closeModal;
    window.showComingSoon = showComingSoon;
    window.addNewArtist = addNewArtist;
    window.createAgibilitaForArtist = createAgibilitaForArtist;
    window.createComunicazione = createComunicazione;

    // Database Manager Functions modificate
    window.toggleDatabaseManager = async function() {
        document.getElementById('databaseManagerModal').style.display = 'block';
        await loadDBArtists();
        await loadDBVenues();
    }

    // Open Chat AI
    window.openChatAI = function() {
        window.location.href = './chat-agibilita.html';
    }
    
    window.closeDatabaseManager = function() {
        document.getElementById('databaseManagerModal').style.display = 'none';
    }
    
    window.showDBTab = function(tabName) {
        // Update tabs
        document.querySelectorAll('#databaseManagerModal .tab').forEach(tab => {
            tab.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // Update content
        document.querySelectorAll('#databaseManagerModal .tab-content').forEach(content => {
            content.style.display = 'none';
        });
        document.getElementById('dbTab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).style.display = 'block';
    }
    
    // Database manager functions adattate per Supabase
    async function loadDBArtists() {
        const tbody = document.getElementById('dbArtistsList');
        const noMsg = document.getElementById('noArtistsMsg');
        
        if (artistsDB.length === 0) {
            tbody.innerHTML = '';
            noMsg.style.display = 'block';
        } else {
            noMsg.style.display = 'none';
            tbody.innerHTML = artistsDB.map(artist => `
                <tr>
                    <td>${artist.nome} ${artist.cognome}${artist.nome_arte ? ' - ' + artist.nome_arte : ''}</td>
                    <td>${artist.codice_fiscale}</td>
                    <td>${artist.mansione}</td>
                    <td class="text-center">
                        <button class="btn btn-danger btn-sm" onclick="removeArtistFromDB('${artist.id}')">
                            üóëÔ∏è Rimuovi
                        </button>
                    </td>
                </tr>
            `).join('');
        }
    }
    
    async function loadDBVenues() {
        const tbody = document.getElementById('dbVenuesList');
        const noMsg = document.getElementById('noVenuesMsg');
        
        if (venuesDB.length === 0) {
            tbody.innerHTML = '';
            noMsg.style.display = 'block';
        } else {
            noMsg.style.display = 'none';
            tbody.innerHTML = venuesDB.map(venue => `
                <tr>
                    <td>${venue.nome}</td>
                    <td>${venue.citta_nome}</td>
                    <td>${venue.indirizzo}</td>
                    <td class="text-center">
                        <button class="btn btn-danger btn-sm" onclick="removeVenueFromDB('${venue.id}')">
                            üóëÔ∏è Rimuovi
                        </button>
                    </td>
                </tr>
            `).join('');
        }
    }
    
    window.loadDBArtists = loadDBArtists;
    window.loadDBVenues = loadDBVenues;
    
    // Funzioni di rimozione adattate (per ora solo client-side, implementare delete su Supabase)
    window.filterDBArtists = function() {
        const searchTerm = document.getElementById('dbSearchArtist').value.toLowerCase();
        const rows = document.querySelectorAll('#dbArtistsList tr');
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchTerm) ? '' : 'none';
        });
    }
    
    window.filterDBVenues = function() {
        const searchTerm = document.getElementById('dbSearchVenue').value.toLowerCase();
        const rows = document.querySelectorAll('#dbVenuesList tr');
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchTerm) ? '' : 'none';
        });
    }
    
    window.removeArtistFromDB = function(artistId) {
        alert('Funzione di rimozione in implementazione - Step successivo!');
    }
    
    window.removeVenueFromDB = function(venueId) {
        alert('Funzione di rimozione in implementazione - Step successivo!');
    }
    
    // Export functions adattate
    window.exportDatabase = function(type) {
        let data = {};
        let filename = '';
        
        switch(type) {
            case 'artisti':
                data = { artisti: artistsDB };
                filename = 'recorp_artisti_export.json';
                break;
            case 'locali':
                data = { locali: venuesDB };
                filename = 'recorp_locali_export.json';
                break;
            case 'all':
                data = { 
                    artisti: artistsDB, 
                    locali: venuesDB, 
                    agibilita: agibilitaDB 
                };
                filename = 'recorp_database_completo.json';
                break;
        }
        
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
    }
    
    window.importDatabase = function(event) {
        alert('Funzione di import in implementazione - Step successivo!');
    }

    // Chiudi modal cliccando fuori
    window.onclick = function(event) {
        const modal = document.getElementById('searchModal');
        const dbModal = document.getElementById('databaseManagerModal');
        
        if (event.target == modal) {
            closeModal();
        }
        
        if (event.target == dbModal) {
            closeDatabaseManager();
        }
    }

    console.log('üéâ Sistema RECORP inizializzato con Supabase!');
</script>
</body>
</html>
