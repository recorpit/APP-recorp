<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RECORP ALL-IN-ONE - Dashboard</title>
    <link rel="stylesheet" href="assets/style.css">
    
    <!-- Security Headers -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
</head>
<body>
    <!-- Auth Guard Protection -->
    <script type="module">
        import { AuthGuard } from './auth-guard.js';

        // Richiedi autenticazione prima di caricare la pagina
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await AuthGuard.requireAuth();
                console.log('‚úÖ Accesso autorizzato alla pagina');
                document.body.classList.add('authenticated');
                
                // Inizializza user info bar
                await initUserInfoBar();
            } catch (error) {
                console.log('‚ùå Accesso negato, redirect in corso...');
            }
        });

        // Inizializza la user info bar
        async function initUserInfoBar() {
            try {
                const userSession = localStorage.getItem('recorp_user_session');
                if (userSession) {
                    const userData = JSON.parse(userSession);
                    document.getElementById('current-user-email').textContent = userData.email;
                    
                    const loginTime = new Date(userData.login_time);
                    const now = new Date();
                    const duration = Math.floor((now - loginTime) / 1000 / 60);
                    document.getElementById('session-info').textContent = `Sessione: ${duration}m`;
                }
            } catch (error) {
                console.error('Errore caricamento info utente:', error);
                document.getElementById('current-user-email').textContent = 'Utente';
            }
        }

        // Gestisci logout
        window.handleLogout = () => {
            if (confirm('Sei sicuro di voler uscire?')) {
                try {
                    import('./auth-guard.js').then(module => {
                        module.AuthGuard.logout();
                    });
                } catch (error) {
                    console.error('Errore logout:', error);
                    localStorage.removeItem('recorp_user_session');
                    window.location.href = './login.html';
                }
            }
        };
    </script>

    <!-- User Info Bar -->
    <div class="user-info-bar">
        <div class="container">
            <div class="user-info">
                <span>Connesso come:</span>
                <span id="current-user-email">Caricamento...</span>
                <span class="status-online">üü¢ Online</span>
            </div>
            
            <div class="user-actions">
                <span id="session-info"></span>
                <button id="logout-btn" onclick="handleLogout()">
                    üö™ Logout Sicuro
                </button>
            </div>
        </div>
    </div>

    <!-- Main Dashboard Container -->
    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header">
            <h1>RECORP</h1>
            <p>Dashboard Gestionale All-in-One</p>
        </header>

        <!-- Statistics -->
        <section class="dashboard-stats-grid">
            <div class="dashboard-stat-card">
                <div class="stat-number" id="agibilita-count">42</div>
                <div class="stat-label">Agibilit√† Totali</div>
            </div>
            <div class="dashboard-stat-card">
                <div class="stat-number" id="month-agibilita">7</div>
                <div class="stat-label">Agibilit√† Mese</div>
            </div>
            <div class="dashboard-stat-card">
                <div class="stat-number" id="artists-count">18</div>
                <div class="stat-label">Artisti Registrati</div>
            </div>
            <div class="dashboard-stat-card">
                <div class="stat-number">‚Ç¨15.2k</div>
                <div class="stat-label">Fatturato Anno</div>
            </div>
        </section>

        <!-- Main Modules -->
        <section class="dashboard-modules-grid">
            <!-- Agibilit√† Module (Primary) -->
            <div class="dashboard-module-card primary">
                <div class="module-icon">üé≠</div>
                <h3 class="module-title">Agibilit√†</h3>
                <p class="module-description">Gestisci richieste e documenti di agibilit√† per spettacoli</p>
                <div class="module-buttons">
                    <button class="btn btn-primary" onclick="startNewAgibilita()">Nuova Agibilit√†</button>
                    <button class="btn btn-secondary" onclick="showEditAgibilita()">Modifica</button>
                    <button class="btn btn-secondary" onclick="showBozzeAgibilita()">Bozze</button>
                </div>
            </div>

            <!-- Comunicazioni Module -->
            <div class="dashboard-module-card">
                <div class="coming-soon">Coming Soon</div>
                <div class="module-icon">üìß</div>
                <h3 class="module-title">Comunicazioni</h3>
                <p class="module-description">Gestisci comunicazioni ufficiali e notifiche</p>
                <div class="module-buttons">
                    <button class="btn btn-disabled" onclick="showComingSoon('Comunicazioni')">Accedi</button>
                </div>
            </div>

            <!-- ‚úÖ PAGAMENTI MODULE ABILITATO - VERSIONE CORRETTA -->
            <div class="dashboard-module-card">
                <div class="module-icon">üí∞</div>
                <h3 class="module-title">Pagamenti</h3>
                <p class="module-description">Gestisci pagamenti, ritenute e compensi artisti</p>
                <div class="module-buttons">
                    <button class="btn btn-primary" onclick="openPagamenti()">Accedi</button>
                    <button class="btn btn-secondary" onclick="showPagamentiStats()">Statistiche</button>
                    <button class="btn btn-outline" onclick="showPagamentiHelp()">Guida</button>
                </div>
                <div class="module-status">
                    <span class="status-active">üü¢ Attivo</span>
                    <span class="module-version">v1.0</span>
                </div>
            </div>

            <!-- Fatturazione Module -->
            <div class="dashboard-module-card">
                <div class="coming-soon">Coming Soon</div>
                <div class="module-icon">üßæ</div>
                <h3 class="module-title">Fatturazione</h3>
                <p class="module-description">Emetti e gestisci fatture elettroniche</p>
                <div class="module-buttons">
                    <button class="btn btn-disabled" onclick="showComingSoon('Fatturazione')">Accedi</button>
                </div>
            </div>
        </section>

        <!-- Drafts Section -->
        <section class="dashboard-drafts-section">
            <h2 class="section-title">üóÇÔ∏è Bozze Salvate</h2>
            <div class="drafts-grid" id="dashboard-drafts-container">
                <div class="draft-card">
                    <div class="draft-header">
                        <div class="draft-info">
                            <h4>AG-2025-014</h4>
                            <p>Scadenza: 29 Luglio 2025</p>
                        </div>
                        <div class="progress-circle progress-30">30%</div>
                    </div>
                    <div class="draft-actions">
                        <button class="btn btn-primary btn-small" onclick="loadBozza('draft_1')">Continua</button>
                    </div>
                </div>

                <div class="draft-card">
                    <div class="draft-header">
                        <div class="draft-info">
                            <h4>AG-2025-013</h4>
                            <p>Scadenza: 30 Luglio 2025</p>
                        </div>
                        <div class="progress-circle progress-65">65%</div>
                    </div>
                    <div class="draft-actions">
                        <button class="btn btn-primary btn-small" onclick="loadBozza('draft_2')">Continua</button>
                    </div>
                </div>

                <div class="draft-card">
                    <div class="draft-header">
                        <div class="draft-info">
                            <h4>AG-2025-012</h4>
                            <p>Scadenza: 31 Luglio 2025</p>
                        </div>
                        <div class="progress-circle progress-90">90%</div>
                    </div>
                    <div class="draft-actions">
                        <button class="btn btn-primary btn-small" onclick="loadBozza('draft_3')">Continua</button>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="dashboard-quick-actions">
                <a href="#" class="quick-action" onclick="addNewArtist()">
                    <span class="quick-action-icon">üìù</span>
                    <div class="quick-action-title">Registra Nuovo Artista</div>
                </a>
                <a href="#" class="quick-action" onclick="searchArtist()">
                    <span class="quick-action-icon">üîç</span>
                    <div class="quick-action-title">Cerca Artista</div>
                </a>
                <a href="#" class="quick-action" onclick="toggleDatabaseManager()">
                    <span class="quick-action-icon">üìä</span>
                    <div class="quick-action-title">Database Manager</div>
                </a>
                <a href="#" class="quick-action" onclick="showCalendarView()">
                    <span class="quick-action-icon">üìÖ</span>
                    <div class="quick-action-title">Vista Calendario</div>
                </a>
            </div>
        </section>
    </div>

    <!-- Chat AI Floating Button -->
    <button class="chat-floating-btn" onclick="toggleChat()">
        ü§ñ
    </button>

    <!-- Chat Modal -->
    <div class="chat-modal" id="chatModal">
        <div class="chat-container">
            <div class="chat-header">
                <h3>ü§ñ Chat AI</h3>
                <button class="chat-close" onclick="closeChat()">‚úï</button>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="chat-message ai">
                    Ciao! Sono l'assistente AI di RECORP. Come posso aiutarti oggi?
                </div>
                <div class="chat-message ai">
                    Posso aiutarti con:
                    ‚Ä¢ Domande sulle agibilit√†
                    ‚Ä¢ Procedure amministrative
                    ‚Ä¢ Ricerca artisti
                    ‚Ä¢ Supporto generale
                </div>
            </div>
            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <textarea 
                        class="chat-input" 
                        id="chatInput" 
                        placeholder="Scrivi il tuo messaggio..."
                        rows="1"
                        onkeypress="handleChatKeypress(event)"
                    ></textarea>
                    <button class="chat-send" onclick="sendMessage()">
                        ‚û§
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Modal (mantenuto dal codice esistente) -->
    <div id="searchModal" class="modal">
        <div class="modal-content modal-content-wide">
            <div class="modal-header">
                <h2>Risultati Ricerca Artisti</h2>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="searchResults"></div>
            </div>
        </div>
    </div>

    <!-- Database Manager Modal (mantenuto dal codice esistente) -->
    <div id="databaseManagerModal" class="modal">
        <div class="modal-content modal-content-wide">
            <div class="modal-header">
                <h2>üóÑÔ∏è Database Manager - RECORP</h2>
                <button class="close-modal" onclick="closeDatabaseManager()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Tab navigation -->
                <div class="tabs">
                    <button class="tab active" onclick="showDBTab('artisti')">
                        <span class="tab-icon">üë•</span>
                        Artisti
                        <span class="tab-badge" id="artistsCount">0</span>
                    </button>
                    <button class="tab" onclick="showDBTab('locali')">
                        <span class="tab-icon">üè¢</span>
                        Locali
                        <span class="tab-badge" id="venuesCount">0</span>
                    </button>
                    <button class="tab" onclick="showDBTab('export')">
                        <span class="tab-icon">üìä</span>
                        Export/Import
                    </button>
                </div>

                <!-- Artisti Tab -->
                <div id="dbTabArtisti" class="tab-content active">
                    <div class="tab-header">
                        <h3>Gestione Artisti Database</h3>
                        <div class="tab-actions">
                            <input type="text" id="dbSearchArtist" placeholder="Cerca artista..." 
                                   onkeyup="filterDBArtists()" class="form-control">
                        </div>
                    </div>
                    
                    <div class="db-table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Nome Completo</th>
                                    <th>Codice Fiscale</th>
                                    <th>Mansione</th>
                                    <th class="text-center">Azioni</th>
                                </tr>
                            </thead>
                            <tbody id="dbArtistsList">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                        <div id="noArtistsMsg" class="no-data-msg">Nessun artista nel database</div>
                    </div>
                </div>

                <!-- Locali Tab -->
                <div id="dbTabLocali" class="tab-content">
                    <div class="tab-header">
                        <h3>Gestione Locali Database</h3>
                        <div class="tab-actions">
                            <input type="text" id="dbSearchVenue" placeholder="Cerca locale..." 
                                   onkeyup="filterDBVenues()" class="form-control">
                        </div>
                    </div>
                    
                    <div class="db-table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Nome Locale</th>
                                    <th>Citt√†</th>
                                    <th>Indirizzo</th>
                                    <th class="text-center">Azioni</th>
                                </tr>
                            </thead>
                            <tbody id="dbVenuesList">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                        <div id="noVenuesMsg" class="no-data-msg">Nessun locale nel database</div>
                    </div>
                </div>

                <!-- Export/Import Tab -->
                <div id="dbTabExport" class="tab-content">
                    <div class="tab-header">
                        <h3>Export e Import Database</h3>
                    </div>
                    
                    <div class="form-section">
                        <h4>üì§ Esporta Dati</h4>
                        <p>Scarica i dati del database in formato JSON per backup o migrazione.</p>
                        <div class="btn-group">
                            <button class="btn btn-secondary" onclick="exportDatabase('artisti')">
                                Export Solo Artisti
                            </button>
                            <button class="btn btn-secondary" onclick="exportDatabase('locali')">
                                Export Solo Locali
                            </button>
                            <button class="btn btn-primary" onclick="exportDatabase('all')">
                                Export Completo
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h4>üì• Importa Dati</h4>
                        <p>Carica dati da file JSON precedentemente esportato.</p>
                        <input type="file" id="importFile" accept=".json" onchange="importDatabase(event)" class="form-control">
                        <div class="import-help-text">
                            ‚ö†Ô∏è <strong>Attenzione:</strong> L'import aggiunger√† nuovi record senza rimuovere quelli esistenti.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="dashboard-footer">
        <div class="footer-content">
            <h3>OKL SRL - RECORP</h3>
            <p>Via Monte Pasubio 222/1 - 36010 Zan√® (VI)<br>P.IVA: 04433920248</p>
            <div class="footer-links">
                <a href="#">Privacy Policy</a>
                <a href="#">Termini di Servizio</a>
                <a href="#">Cookie Policy</a>
            </div>
            <p class="footer-copyright">Copyright ¬© 2025 OKL SRL. Tutti i diritti riservati.</p>
        </div>
    </footer>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="loading-spinner"></div>
        <div>Caricamento dati sicuri...</div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module" src="./supabase-config.js"></script>
    <script type="module" src="./homepage.js"></script>
    <script type="module" src="./chat-ai.js"></script>

    <script type="module">
        // Import agibilita functions for dashboard integration
        window.startNewAgibilita = function() {
            window.location.href = './agibilita/index.html';
        };

        window.showEditAgibilita = async function() {
            try {
                // Dinamicamente importa e chiama la funzione da agibilita.js
                const agibilitaModule = await import('./agibilita/agibilita.js');
                if (agibilitaModule.showEditAgibilita) {
                    agibilitaModule.showEditAgibilita();
                } else {
                    // Fallback: redirect diretto
                    window.location.href = './agibilita/index.html?action=edit';
                }
            } catch (error) {
                console.error('Errore caricamento modulo agibilit√†:', error);
                window.location.href = './agibilita/index.html?action=edit';
            }
        };

        window.showBozzeAgibilita = async function() {
            try {
                // Dinamicamente importa e chiama la funzione da agibilita.js
                const agibilitaModule = await import('./agibilita/agibilita.js');
                if (agibilitaModule.showBozzeAgibilita) {
                    agibilitaModule.showBozzeAgibilita();
                } else {
                    // Fallback: redirect diretto
                    window.location.href = './agibilita/index.html?action=bozze';
                }
            } catch (error) {
                console.error('Errore caricamento modulo agibilit√†:', error);
                window.location.href = './agibilita/index.html?action=bozze';
            }
        };

        window.loadBozza = async function(bozzaId) {
            try {
                // Salva ID bozza per agibilit√† page
                sessionStorage.setItem('loadBozzaId', bozzaId);
                window.location.href = './agibilita/index.html?action=load-bozza&id=' + bozzaId;
            } catch (error) {
                console.error('Errore caricamento bozza:', error);
                showToast('Errore nel caricamento della bozza', 'error');
            }
        };

        window.showComingSoon = function(moduleName) {
            showToast(`Il modulo "${moduleName}" √® in fase di sviluppo e sar√† disponibile presto!`, 'info');
        };

        window.showCalendarView = async function() {
            try {
                const agibilitaModule = await import('./agibilita/agibilita.js');
                if (agibilitaModule.showCalendarView) {
                    agibilitaModule.showCalendarView();
                } else {
                    showToast('Vista calendario in sviluppo', 'info');
                }
            } catch (error) {
                showToast('Vista calendario in sviluppo', 'info');
            }
        };

        // Chat functions placeholder (will be implemented in chat-ai.js)
        window.toggleChat = function() {
            const modal = document.getElementById('chatModal');
            modal.classList.add('open');
            document.getElementById('chatInput').focus();
        };

        window.closeChat = function() {
            const modal = document.getElementById('chatModal');
            modal.classList.remove('open');
        };

        window.sendMessage = function() {
            const input = document.getElementById('chatInput');
            const messages = document.getElementById('chatMessages');
            const message = input.value.trim();
            
            if (!message) return;

            // Add user message
            const userMsg = document.createElement('div');
            userMsg.className = 'chat-message user';
            userMsg.textContent = message;
            messages.appendChild(userMsg);

            // Clear input
            input.value = '';
            
            // Scroll to bottom
            messages.scrollTop = messages.scrollHeight;

            // Simulate AI response
            setTimeout(() => {
                const aiMsg = document.createElement('div');
                aiMsg.className = 'chat-message ai';
                aiMsg.textContent = 'Grazie per il tuo messaggio! Sto elaborando la tua richiesta...';
                messages.appendChild(aiMsg);
                messages.scrollTop = messages.scrollHeight;
            }, 1000);
        };

        window.handleChatKeypress = function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        };

        // Close chat when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('chatModal');
            const chatContainer = document.querySelector('.chat-container');
            const chatBtn = document.querySelector('.chat-floating-btn');
            
            if (modal.classList.contains('open') && 
                !chatContainer.contains(event.target) && 
                !chatBtn.contains(event.target)) {
                closeChat();
            }
        });

        // Toast notification function
        window.showToast = function(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'error' ? '#dc2626' : type === 'success' ? '#10b981' : type === 'warning' ? '#f59e0b' : '#2563eb'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 1000;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateX(0)';
            }, 100);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 5000);
        };
    </script>
</body>
</html>