<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Pagamenti - RECORP ALL-IN-ONE</title>
    
    <!-- 🎨 CSS - ORDINE CORRETTO -->
    <link rel="stylesheet" href="../assets/style.css">
    <link rel="stylesheet" href="pagamenti-styles.css">
    
    <!-- 🔥 CARICA SUPABASE VIA CDN PRIMA DI TUTTO -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://nommluymuwioddhaujxu.supabase.co https://cdn.jsdelivr.net; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com;">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loading-text">🔄 Inizializzazione sistema pagamenti...</div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Header Navigation -->
    <header class="main-header">
        <div class="header-content">
            <div class="header-left">
                <h1 class="page-title">💰 Gestione Pagamenti</h1>
                <nav class="breadcrumb">
                    <a href="../index.html">🏠 Dashboard</a>
                    <span class="separator">→</span>
                    <span class="current">Pagamenti</span>
                </nav>
            </div>
            <div class="header-right">
                <button class="btn btn-primary" onclick="syncPaymentsFromAgibilita()" disabled>
                    🔄 Sincronizza da Agibilità
                </button>
                <button class="btn btn-secondary" onclick="showPaymentSettings()" disabled>
                    ⚙️ Impostazioni
                </button>
                <button class="btn btn-warning" onclick="goBackToDashboard()">
                    ← Torna alla Dashboard
                </button>
                <button class="btn btn-danger" onclick="handleLogout()">
                    🚪 Logout
                </button>
            </div>
        </div>
    </header>

    <!-- Executive Dashboard -->
    <section class="executive-dashboard">
        <div class="dashboard-header">
            <h2>📊 Dashboard Esecutivo</h2>
            <div class="dashboard-actions">
                <button class="btn btn-sm btn-outline" onclick="autoCalculateAllPayments()" disabled>
                    🧮 Calcola Tutti
                </button>
                <button class="btn btn-sm btn-outline" onclick="approveAllPending()" disabled>
                    ✅ Approva Tutti Pendenti
                </button>
                <button class="btn btn-sm btn-outline" onclick="generateMonthlyReport()" disabled>
                    📋 Report Mensile
                </button>
            </div>
        </div>
        
        <div class="dashboard-cards">
            <div class="dashboard-card primary">
                <div class="card-icon">💰</div>
                <div class="card-content">
                    <div class="card-value" id="totaleDaPagare">€0,00</div>
                    <div class="card-label">Totale da Pagare</div>
                    <div class="card-trend" id="trendDaPagare">Caricamento...</div>
                </div>
                <div class="card-actions">
                    <button class="btn btn-xs btn-primary" onclick="showProcessPayments()" disabled>Elabora</button>
                </div>
            </div>
            
            <div class="dashboard-card success">
                <div class="card-icon">👥</div>
                <div class="card-content">
                    <div class="card-value" id="numeroArtisti">0</div>
                    <div class="card-label">Artisti da Pagare</div>
                    <div class="card-trend" id="trendArtisti">Caricamento...</div>
                </div>
                <div class="card-actions">
                    <button class="btn btn-xs btn-outline" onclick="showPendingApprovals()" disabled>Visualizza</button>
                </div>
            </div>
            
            <div class="dashboard-card info">
                <div class="card-icon">📅</div>
                <div class="card-content">
                    <div class="card-value" id="pagamentiMese">€0,00</div>
                    <div class="card-label">Pagamenti Mese</div>
                    <div class="card-trend" id="trendMese">Caricamento...</div>
                </div>
            </div>
            
            <div class="dashboard-card warning">
                <div class="card-icon">🧾</div>
                <div class="card-content">
                    <div class="card-value" id="ritenuteApplicate">€0,00</div>
                    <div class="card-label">Ritenute Applicate</div>
                    <div class="card-trend" id="trendRitenute">Caricamento...</div>
                </div>
            </div>
        </div>
        
        <!-- Advanced Filters -->
        <div class="filters-section">
            <div class="filters-header">
                <h3>🔍 Filtri Avanzati</h3>
                <div class="filter-actions">
                    <button class="btn btn-xs btn-outline" onclick="saveFilterPreset()" disabled>💾 Salva Preset</button>
                    <button class="btn btn-xs btn-secondary" onclick="resetAdvancedFilters()" disabled>🔄 Reset</button>
                </div>
            </div>
            
            <div class="filters-grid">
                <div class="filter-group">
                    <label for="filterStato">Stato</label>
                    <select id="filterStato" onchange="applyAdvancedFilters()" disabled>
                        <option value="">Tutti</option>
                        <option value="da_pagare">Da Pagare</option>
                        <option value="autorizzato">Autorizzato</option>
                        <option value="pagato">Pagato</option>
                        <option value="annullato">Annullato</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filterDateFrom">Data Da</label>
                    <input type="date" id="filterDateFrom" onchange="applyAdvancedFilters()" disabled>
                </div>
                
                <div class="filter-group">
                    <label for="filterDateTo">Data A</label>
                    <input type="date" id="filterDateTo" onchange="applyAdvancedFilters()" disabled>
                </div>
                
                <div class="filter-group">
                    <label for="filterTipoContratto">Tipo Contratto</label>
                    <select id="filterTipoContratto" onchange="applyAdvancedFilters()" disabled>
                        <option value="">Tutti</option>
                        <option value="occasionale">Prestazione Occasionale</option>
                        <option value="partitaiva">Partita IVA</option>
                        <option value="chiamata">Contratto a Chiamata</option>
                        <option value="dipendente">Dipendente</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filterArtista">Cerca Artista</label>
                    <input type="text" id="filterArtista" placeholder="Nome, cognome o CF..." disabled>
                </div>
                
                <div class="filter-group">
                    <label for="filterImportoMin">Importo Minimo</label>
                    <input type="number" id="filterImportoMin" min="0" step="0.01" placeholder="0,00" onchange="applyAdvancedFilters()" disabled>
                </div>
            </div>
        </div>
        
        <!-- System Status -->
        <div class="system-status">
            <div class="status-item">
                <span class="status-icon" id="dbStatus">🟡</span>
                <span class="status-label">Database: <span id="dbStatusText">Connessione...</span></span>
            </div>
            <div class="status-item">
                <span class="status-icon" id="authStatus">🟡</span>
                <span class="status-label">Auth: <span id="authStatusText">Verifica...</span></span>
            </div>
            <div class="status-item">
                <span class="status-icon" id="systemStatus">🟡</span>
                <span class="status-label">Sistema: <span id="systemStatusText">Inizializzazione...</span></span>
            </div>
        </div>
    </section>

    <!-- Payment Tabs Navigation -->
    <div class="payment-tabs">
        <div class="tab active" id="tabOccasionali" onclick="showPaymentTab('occasionali')">
            <span class="tab-icon">🎭</span>
            <span class="tab-label">Prestazioni Occasionali</span>
            <span class="tab-badge" id="badgeOccasionale">0</span>
        </div>
        <div class="tab" id="tabPartitaIva" onclick="showPaymentTab('partitaiva')">
            <span class="tab-icon">🏢</span>
            <span class="tab-label">Partite IVA</span>
            <span class="tab-badge" id="badgePartitaIva">0</span>
        </div>
        <div class="tab" id="tabDipendenti" onclick="showPaymentTab('dipendenti')">
            <span class="tab-icon">👔</span>
            <span class="tab-label">Dipendenti</span>
            <span class="tab-badge" id="badgeDipendenti">0</span>
        </div>
        <div class="tab" id="tabCiv" onclick="showPaymentTab('civ')">
            <span class="tab-icon">🏦</span>
            <span class="tab-label">CIV Bancari</span>
        </div>
        <div class="tab" id="tabAudit" onclick="showPaymentTab('audit')">
            <span class="tab-icon">📋</span>
            <span class="tab-label">Audit</span>
        </div>
    </div>

    <!-- Tab Contents -->
    <div class="payment-content">
        
        <!-- Prestazioni Occasionali Tab -->
        <div class="tab-content active" id="tabContentOccasionali">
            <div class="tab-header">
                <h3>🎭 Prestazioni Occasionali</h3>
                <div class="tab-actions">
                    <button class="btn btn-sm btn-outline" onclick="selectAllOccasionali()" disabled>
                        ☑️ Seleziona Tutti
                    </button>
                    <button class="btn btn-sm btn-success" onclick="approveSelectedOccasionali()" disabled>
                        ✅ Approva Selezionati
                    </button>
                    <button class="btn btn-sm btn-primary" onclick="calculateRetentions()" disabled>
                        🧮 Ricalcola Ritenute
                    </button>
                </div>
            </div>
            
            <div class="payment-help">
                <div class="help-content">
                    <strong>ℹ️ Prestazioni Occasionali:</strong>
                    Ritenuta IRPEF del 20% applicata su compensi superiori a €25,82. 
                    Soglia annua €5.000 per persona fisica.
                </div>
            </div>
            
            <div class="payment-list" id="listOccasionale">
                <div class="no-data">
                    <div class="loading-spinner"></div>
                    <p>Caricamento pagamenti occasionali...</p>
                </div>
            </div>
        </div>

        <!-- Partite IVA Tab -->
        <div class="tab-content" id="tabContentPartitaiva">
            <div class="tab-header">
                <h3>🏢 Partite IVA</h3>
                <div class="tab-actions">
                    <button class="btn btn-sm btn-outline" onclick="checkAllInvoices()" disabled>
                        📧 Verifica Fatture
                    </button>
                    <button class="btn btn-sm btn-warning" onclick="markAllInvoicesReceived()" disabled>
                        ✅ Conferma Tutte Ricevute
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="generateInvoiceReminders()" disabled>
                        📬 Genera Solleciti
                    </button>
                </div>
            </div>
            
            <div class="payment-help">
                <div class="help-content">
                    <strong>ℹ️ Partite IVA:</strong>
                    Nessuna ritenuta applicata. Fattura obbligatoria prima del pagamento.
                    Verificare dati fattura e IBAN prima dell'approvazione.
                </div>
            </div>
            
            <div class="payment-list" id="listPartitaIva">
                <div class="no-data">
                    <div class="loading-spinner"></div>
                    <p>Caricamento pagamenti partite IVA...</p>
                </div>
            </div>
        </div>

        <!-- Dipendenti Tab -->
        <div class="tab-content" id="tabContentDipendenti">
            <div class="tab-header">
                <h3>👔 Dipendenti e Contratti a Chiamata</h3>
                <div class="tab-actions">
                    <button class="btn btn-sm btn-primary" onclick="generatePayrollExport()" disabled>
                        📤 Export Buste Paga
                    </button>
                    <button class="btn btn-sm btn-outline" onclick="calculateContributions()" disabled>
                        🧮 Calcola Contributi
                    </button>
                </div>
            </div>
            
            <div class="payment-help">
                <div class="help-content">
                    <strong>ℹ️ Dipendenti:</strong>
                    Gestione attraverso sistema paghe. IRPEF e contributi INPS calcolati automaticamente.
                    I pagamenti vengono elaborati tramite cedolino mensile.
                </div>
            </div>
            
            <div class="payment-list" id="listDipendenti">
                <div class="no-data">
                    <div class="loading-spinner"></div>
                    <p>Caricamento pagamenti dipendenti...</p>
                </div>
            </div>
        </div>

        <!-- CIV Bancari Tab -->
        <div class="tab-content" id="tabContentCiv">
            <div class="tab-header">
                <h3>🏦 Generazione CIV Bancari</h3>
                <div class="tab-actions">
                    <select id="selectBanca" class="form-select" disabled>
                        <option value="">Seleziona Banca</option>
                        <option value="intesa">Intesa Sanpaolo</option>
                        <option value="unicredit">UniCredit</option>
                        <option value="bnl">BNL</option>
                        <option value="monte_paschi">Monte dei Paschi</option>
                        <option value="banco_bpm">Banco BPM</option>
                        <option value="generic">Formato Generico</option>
                    </select>
                    <button class="btn btn-sm btn-success" onclick="generateAdvancedCIV()" disabled>
                        📤 Genera CIV
                    </button>
                </div>
            </div>
            
            <div class="civ-preview">
                <div class="civ-summary">
                    <div class="summary-item">
                        <span class="summary-label">Beneficiari:</span>
                        <span class="summary-value" id="civNumBeneficiari">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Totale Lordo:</span>
                        <span class="summary-value" id="civTotaleLordo">€0,00</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Ritenute:</span>
                        <span class="summary-value" id="civTotaleRitenute">€0,00</span>
                    </div>
                    <div class="summary-item total">
                        <span class="summary-label">Totale Netto:</span>
                        <span class="summary-value" id="civTotaleNetto">€0,00</span>
                    </div>
                </div>
                
                <div class="civ-preview-list" id="civPreviewList">
                    <p class="no-data">Nessun pagamento selezionato per CIV</p>
                </div>
            </div>
        </div>

        <!-- Audit Tab -->
        <div class="tab-content" id="tabContentAudit">
            <div class="tab-header">
                <h3>📋 Audit Trail e Log Sistema</h3>
                <div class="tab-actions">
                    <button class="btn btn-sm btn-outline" onclick="exportAuditLog()" disabled>
                        📤 Export Log
                    </button>
                    <button class="btn btn-sm btn-warning" onclick="clearOldLogs()" disabled>
                        🗑️ Pulisci Log Vecchi
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="showPaymentHistory()" disabled>
                        📈 Storico Pagamenti
                    </button>
                </div>
            </div>
            
            <div class="audit-summary">
                <div class="recent-activity">
                    <h4>🕒 Attività Recenti</h4>
                    <div id="recentActivityList" class="activity-list">
                        <p class="no-data">Caricamento attività...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="main-footer">
        <div class="footer-content">
            <div class="company-info">
                <strong>OKL SRL - RECORP</strong><br>
                Via Monte Pasubio 222/1 - 36010 Zanè (VI)<br>
                P.IVA: 04433920248
            </div>
            <div class="footer-links">
                <a href="#privacy">Privacy Policy</a>
                <a href="#terms">Termini di Servizio</a>
                <a href="#cookies">Cookie Policy</a>
            </div>
            <div class="footer-copyright">
                © 2025 OKL SRL - Tutti i diritti riservati
            </div>
        </div>
    </footer>

    <!-- 🔥 JAVASCRIPT STEP-BY-STEP SICURO -->
    <script>
        // ==================== VARIABILI GLOBALI ====================
        let systemReady = false;
        let currentUser = null;
        let supabaseClient = null;
        
        // ==================== FUNZIONI BASE ====================
        function updateLoadingText(message) {
            const loadingText = document.getElementById('loading-text');
            if (loadingText) {
                loadingText.textContent = message;
            }
            console.log('🔄 ' + message);
        }
        
        function updateSystemStatus(component, status, message) {
            const statusIcon = document.getElementById(component + 'Status');
            const statusText = document.getElementById(component + 'StatusText');
            
            if (statusIcon && statusText) {
                statusIcon.textContent = status === 'ok' ? '🟢' : status === 'warning' ? '🟡' : '🔴';
                statusText.textContent = message;
            }
        }
        
        function showToast(message, type = 'info') {
            console.log(`[TOAST] ${type.toUpperCase()}: ${message}`);
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <div class="toast-content">
                    <span class="toast-icon">${type === 'success' ? '✅' : type === 'error' ? '❌' : type === 'warning' ? '⚠️' : 'ℹ️'}</span>
                    <span class="toast-message">${message}</span>
                </div>
            `;
            
            const container = document.getElementById('toast-container');
            if (container) {
                container.appendChild(toast);
                
                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 5000);
            }
        }
        
        function enableButtons() {
            document.querySelectorAll('button[disabled], select[disabled], input[disabled]').forEach(el => {
                el.disabled = false;
            });
        }
        
        // ==================== INIZIALIZZAZIONE STEP-BY-STEP ====================
        async function initializeSystem() {
            try {
                updateLoadingText('🔐 Verifica autenticazione...');
                
                // STEP 1: Verifica autenticazione localStorage
                const sessionData = localStorage.getItem('recorp_user_session');
                if (!sessionData) {
                    throw new Error('Nessuna sessione trovata - Redirect al login');
                }
                
                const session = JSON.parse(sessionData);
                if (!session.email) {
                    throw new Error('Sessione incompleta - Redirect al login');
                }
                
                // Verifica scadenza
                if (session.expires_at) {
                    const expiresAt = new Date(session.expires_at * 1000);
                    if (expiresAt <= new Date()) {
                        throw new Error('Sessione scaduta - Redirect al login');
                    }
                }
                
                currentUser = {
                    email: session.email,
                    id: session.user_id,
                    isLocal: true
                };
                
                updateSystemStatus('auth', 'ok', `Autenticato: ${session.email}`);
                updateLoadingText('✅ Autenticazione verificata');
                
                // STEP 2: Verifica Supabase client
                updateLoadingText('🔌 Connessione database...');
                
                if (!window.supabase) {
                    throw new Error('Supabase client non caricato dal CDN');
                }
                
                // Inizializza client Supabase
                supabaseClient = window.supabase.createClient(
                    'https://nommluymuwioddhaujxu.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vbW1sdXltdXdpb2RkaGF1anh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5ODA5MjgsImV4cCI6MjA2NzU1NjkyOH0.oaF5uaNe21W8NU67n1HjngngMUClkss2achTQ7BZ5tE'
                );
                
                // Test connessione database
                const { data, error } = await supabaseClient
                    .from('artisti')
                    .select('count')
                    .limit(1);
                
                if (error && error.code !== '42P01') {
                    console.warn('⚠️ Warning database:', error);
                    updateSystemStatus('db', 'warning', 'Connesso (con avvisi)');
                } else {
                    updateSystemStatus('db', 'ok', 'Connesso');
                }
                
                updateLoadingText('✅ Database connesso');
                
                // STEP 3: Carica sistema pagamenti
                updateLoadingText('📥 Caricamento moduli sistema...');
                
                // Carica i moduli JavaScript in modo sicuro
                await loadPaymentModules();
                
                updateLoadingText('✅ Sistema inizializzato');
                updateSystemStatus('system', 'ok', 'Operativo');
                
                // STEP 4: Finalizza
                systemReady = true;
                enableButtons();
                
                // Nascondi loading
                const loadingOverlay = document.getElementById('loading-overlay');
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'none';
                }
                
                showToast('✅ Sistema pagamenti pronto!', 'success');
                console.log('🎉 Inizializzazione completata con successo');
                
            } catch (error) {
                console.error('❌ Errore inizializzazione:', error);
                updateSystemStatus('system', 'error', 'Errore');
                
                if (error.message.includes('Redirect al login')) {
                    updateLoadingText('🔄 Reindirizzamento al login...');
                    setTimeout(() => {
                        window.location.href = '../login.html';
                    }, 2000);
                } else {
                    updateLoadingText('❌ Errore: ' + error.message);
                    showToast('Errore: ' + error.message, 'error');
                }
            }
        }
        
        async function loadPaymentModules() {
            try {
                // Carica i moduli solo se il DOM è pronto e Supabase è disponibile
                if (supabaseClient && document.readyState === 'complete') {
                    // I moduli verranno caricati dinamicamente qui
                    // Per ora simula il caricamento
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // Imposta dati mock per test
                    updateMockData();
                    
                    console.log('✅ Moduli pagamenti caricati');
                } else {
                    throw new Error('Prerequisiti non soddisfatti per caricamento moduli');
                }
            } catch (error) {
                console.error('❌ Errore caricamento moduli:', error);
                throw error;
            }
        }
        
        function updateMockData() {
            // Aggiorna dashboard con dati mock per test
            document.getElementById('totaleDaPagare').textContent = '€1.234,56';
            document.getElementById('numeroArtisti').textContent = '12';
            document.getElementById('pagamentiMese').textContent = '€5.678,90';
            document.getElementById('ritenuteApplicate').textContent = '€987,65';
            
            document.getElementById('trendDaPagare').textContent = 'In attesa di approvazione';
            document.getElementById('trendArtisti').textContent = '12 in coda';
            document.getElementById('trendMese').textContent = 'Mese corrente';
            document.getElementById('trendRitenute').textContent = 'Anno fiscale 2025';
            
            // Aggiorna badge tabs
            document.getElementById('badgeOccasionale').textContent = '8';
            document.getElementById('badgePartitaIva').textContent = '3';
            document.getElementById('badgeDipendenti').textContent = '1';
            
            // Mostra placeholder di test nelle liste
            const listOccasionale = document.getElementById('listOccasionale');
            const listPartitaIva = document.getElementById('listPartitaIva');
            const listDipendenti = document.getElementById('listDipendenti');
            
            if (listOccasionale) {
                listOccasionale.innerHTML = '<p class="no-data">✅ Sistema pronto - 8 prestazioni occasionali disponibili<br><small>Sistema completo sarà caricato quando risolveremo il loop originale</small></p>';
            }
            
            if (listPartitaIva) {
                listPartitaIva.innerHTML = '<p class="no-data">✅ Sistema pronto - 3 partite IVA disponibili<br><small>Sistema completo sarà caricato quando risolveremo il loop originale</small></p>';
            }
            
            if (listDipendenti) {
                listDipendenti.innerHTML = '<p class="no-data">✅ Sistema pronto - 1 dipendente disponibile<br><small>Sistema completo sarà caricato quando risolveremo il loop originale</small></p>';
            }
        }
        
        // ==================== FUNZIONI PLACEHOLDER ====================
        function goBackToDashboard() {
            window.location.href = '../index.html';
        }
        
        function handleLogout() {
            if (confirm('Sei sicuro di voler uscire dal sistema RECORP?')) {
                localStorage.removeItem('recorp_user_session');
                sessionStorage.clear();
                window.location.href = '../login.html';
            }
        }
        
        function showPaymentTab(tabName) {
            // Rimuovi active da tutti i tab
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Attiva tab selezionato
            const targetTab = document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
            const targetContent = document.getElementById(`tabContent${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
            
            if (targetTab) targetTab.classList.add('active');
            if (targetContent) targetContent.classList.add('active');
        }
        
        // Tutte le altre funzioni placeholder
        function syncPaymentsFromAgibilita() { showToast('Sincronizzazione in sviluppo', 'info'); }
        function showPaymentSettings() { showToast('Impostazioni in sviluppo', 'info'); }
        function autoCalculateAllPayments() { showToast('Calcolo automatico in sviluppo', 'info'); }
        function approveAllPending() { showToast('Approvazione automatica in sviluppo', 'info'); }
        function generateMonthlyReport() { showToast('Report mensile in sviluppo', 'info'); }
        function showProcessPayments() { showPaymentTab('occasionali'); }
        function showPendingApprovals() { showPaymentTab('occasionali'); }
        function saveFilterPreset() { showToast('Salvataggio preset in sviluppo', 'info'); }
        function resetAdvancedFilters() { showToast('Reset filtri in sviluppo', 'info'); }
        function applyAdvancedFilters() { console.log('Filtri applicati'); }
        function selectAllOccasionali() { showToast('Selezione in sviluppo', 'info'); }
        function approveSelectedOccasionali() { showToast('Approvazione in sviluppo', 'info'); }
        function calculateRetentions() { showToast('Calcolo ritenute in sviluppo', 'info'); }
        function checkAllInvoices() { showToast('Verifica fatture in sviluppo', 'info'); }
        function markAllInvoicesReceived() { showToast('Conferma fatture in sviluppo', 'info'); }
        function generateInvoiceReminders() { showToast('Solleciti in sviluppo', 'info'); }
        function generatePayrollExport() { showToast('Export cedolini in sviluppo', 'info'); }
        function calculateContributions() { showToast('Calcolo contributi in sviluppo', 'info'); }
        function generateAdvancedCIV() { showToast('Generazione CIV in sviluppo', 'info'); }
        function exportAuditLog() { showToast('Export audit in sviluppo', 'info'); }
        function clearOldLogs() { showToast('Pulizia log in sviluppo', 'info'); }
        function showPaymentHistory() { showPaymentTab('audit'); }
        
        // ==================== INIZIALIZZAZIONE ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 DOM caricato, avvio inizializzazione sicura...');
            
            // Aggiungi delay per assicurare che tutto sia caricato
            setTimeout(initializeSystem, 100);
        });
        
        // Error handling globale
        window.addEventListener('error', function(event) {
            console.error('❌ JavaScript Error:', event.error);
            updateSystemStatus('system', 'error', 'Errore JS');
        });
        
        window.addEventListener('unhandledrejection', function(event) {
            console.error('❌ Promise Rejection:', event.reason);
            updateSystemStatus('system', 'error', 'Promise Error');
        });
        
        console.log('💰 Pagamenti SAFE inizializzato');
    </script>
</body>
</html>