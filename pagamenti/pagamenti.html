<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Pagamenti - RECORP ALL-IN-ONE</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="../assets/style.css">
    
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://nommluymuwioddhaujxu.supabase.co; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com;">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    
    <!-- Preload Critical Resources -->
    <link rel="preload" href="../assets/style.css" as="style">
    <link rel="preload" href="../supabase-config.js" as="script">
    <link rel="preload" href="../auth-guard.js" as="script">
</head>
<body>
    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Header Navigation -->
    <header class="main-header">
        <div class="header-content">
            <div class="header-left">
                <h1 class="page-title">💰 Gestione Pagamenti</h1>
                <nav class="breadcrumb">
                    <a href="../index.html">🏠 Dashboard</a>
                    <span class="separator">→</span>
                    <span class="current">Pagamenti</span>
                </nav>
            </div>
            <div class="header-right">
                <button class="btn btn-primary" onclick="syncPaymentsFromAgibilita()">
                    🔄 Sincronizza da Agibilità
                </button>
                <button class="btn btn-secondary" onclick="showPaymentSettings()">
                    ⚙️ Impostazioni
                </button>
            </div>
        </div>
    </header>

    <!-- Executive Dashboard -->
    <section class="executive-dashboard">
        <div class="dashboard-header">
            <h2>📊 Dashboard Esecutivo</h2>
            <div class="dashboard-actions">
                <button class="btn btn-sm btn-outline" onclick="autoCalculateAllPayments()">
                    🧮 Calcola Tutti
                </button>
                <button class="btn btn-sm btn-outline" onclick="approveAllPending()">
                    ✅ Approva Tutti Pendenti
                </button>
                <button class="btn btn-sm btn-outline" onclick="generateMonthlyReport()">
                    📋 Report Mensile
                </button>
            </div>
        </div>
        
        <div class="dashboard-cards">
            <div class="dashboard-card primary">
                <div class="card-icon">💰</div>
                <div class="card-content">
                    <div class="card-value" id="totaleDaPagare">€0,00</div>
                    <div class="card-label">Totale da Pagare</div>
                    <div class="card-trend" id="trendDaPagare">In attesa di approvazione</div>
                </div>
                <div class="card-actions">
                    <button class="btn btn-xs btn-primary" onclick="showProcessPayments()">Elabora</button>
                </div>
            </div>
            
            <div class="dashboard-card success">
                <div class="card-icon">👥</div>
                <div class="card-content">
                    <div class="card-value" id="numeroArtisti">0</div>
                    <div class="card-label">Artisti da Pagare</div>
                    <div class="card-trend" id="trendArtisti">0 in coda</div>
                </div>
                <div class="card-actions">
                    <button class="btn btn-xs btn-outline" onclick="showPendingApprovals()">Visualizza</button>
                </div>
            </div>
            
            <div class="dashboard-card info">
                <div class="card-icon">📅</div>
                <div class="card-content">
                    <div class="card-value" id="pagamentiMese">€0,00</div>
                    <div class="card-label">Pagamenti Mese</div>
                    <div class="card-trend" id="trendMese">Mese corrente</div>
                </div>
            </div>
            
            <div class="dashboard-card warning">
                <div class="card-icon">🧾</div>
                <div class="card-content">
                    <div class="card-value" id="ritenuteApplicate">€0,00</div>
                    <div class="card-label">Ritenute Applicate</div>
                    <div class="card-trend" id="trendRitenute">Anno fiscale 2025</div>
                </div>
            </div>
        </div>
        
        <!-- Advanced Filters -->
        <div class="filters-section">
            <div class="filters-header">
                <h3>🔍 Filtri Avanzati</h3>
                <div class="filter-actions">
                    <button class="btn btn-xs btn-outline" onclick="saveFilterPreset()">💾 Salva Preset</button>
                    <button class="btn btn-xs btn-secondary" onclick="resetAdvancedFilters()">🔄 Reset</button>
                </div>
            </div>
            
            <div class="filters-grid">
                <div class="filter-group">
                    <label for="filterStato">Stato</label>
                    <select id="filterStato" onchange="applyAdvancedFilters()">
                        <option value="">Tutti</option>
                        <option value="da_pagare">Da Pagare</option>
                        <option value="autorizzato">Autorizzato</option>
                        <option value="pagato">Pagato</option>
                        <option value="annullato">Annullato</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filterDateFrom">Data Da</label>
                    <input type="date" id="filterDateFrom" onchange="applyAdvancedFilters()">
                </div>
                
                <div class="filter-group">
                    <label for="filterDateTo">Data A</label>
                    <input type="date" id="filterDateTo" onchange="applyAdvancedFilters()">
                </div>
                
                <div class="filter-group">
                    <label for="filterTipoContratto">Tipo Contratto</label>
                    <select id="filterTipoContratto" onchange="applyAdvancedFilters()">
                        <option value="">Tutti</option>
                        <option value="occasionale">Prestazione Occasionale</option>
                        <option value="partitaiva">Partita IVA</option>
                        <option value="chiamata">Contratto a Chiamata</option>
                        <option value="dipendente">Dipendente</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filterArtista">Cerca Artista</label>
                    <input type="text" id="filterArtista" placeholder="Nome, cognome o CF...">
                </div>
                
                <div class="filter-group">
                    <label for="filterImportoMin">Importo Minimo</label>
                    <input type="number" id="filterImportoMin" min="0" step="0.01" placeholder="0,00" onchange="applyAdvancedFilters()">
                </div>
            </div>
        </div>
        
        <!-- System Status -->
        <div class="system-status">
            <div class="status-item">
                <span class="status-icon" id="dbStatus">🟢</span>
                <span class="status-label">Database: <span id="dbStatusText">Connesso</span></span>
            </div>
            <div class="status-item">
                <span class="status-icon" id="bankApiStatus">🟡</span>
                <span class="status-label">API Banche: <span id="bankApiStatusText">Test Mode</span></span>
            </div>
            <div class="status-item">
                <span class="status-icon" id="taxApiStatus">🟢</span>
                <span class="status-label">Sistema Tasse: <span id="taxApiStatusText">Operativo</span></span>
            </div>
        </div>
    </section>

    <!-- Payment Tabs Navigation -->
    <div class="payment-tabs">
        <div class="tab active" id="tabOccasionali" onclick="showPaymentTab('occasionali')">
            <span class="tab-icon">🎭</span>
            <span class="tab-label">Prestazioni Occasionali</span>
            <span class="tab-badge" id="badgeOccasionale">0</span>
        </div>
        <div class="tab" id="tabPartitaIva" onclick="showPaymentTab('partitaiva')">
            <span class="tab-icon">🏢</span>
            <span class="tab-label">Partite IVA</span>
            <span class="tab-badge" id="badgePartitaIva">0</span>
        </div>
        <div class="tab" id="tabDipendenti" onclick="showPaymentTab('dipendenti')">
            <span class="tab-icon">👔</span>
            <span class="tab-label">Dipendenti</span>
            <span class="tab-badge" id="badgeDipendenti">0</span>
        </div>
        <div class="tab" id="tabCiv" onclick="showPaymentTab('civ')">
            <span class="tab-icon">🏦</span>
            <span class="tab-label">CIV Bancari</span>
        </div>
        <div class="tab" id="tabAudit" onclick="showPaymentTab('audit')">
            <span class="tab-icon">📋</span>
            <span class="tab-label">Audit</span>
        </div>
    </div>

    <!-- Tab Contents -->
    <div class="payment-content">
        
        <!-- Prestazioni Occasionali Tab -->
        <div class="tab-content active" id="tabContentOccasionali">
            <div class="tab-header">
                <h3>🎭 Prestazioni Occasionali</h3>
                <div class="tab-actions">
                    <button class="btn btn-sm btn-outline" onclick="selectAllOccasionali()">
                        ☑️ Seleziona Tutti
                    </button>
                    <button class="btn btn-sm btn-success" onclick="approveSelectedOccasionali()">
                        ✅ Approva Selezionati
                    </button>
                    <button class="btn btn-sm btn-primary" onclick="calculateRetentions()">
                        🧮 Ricalcola Ritenute
                    </button>
                </div>
            </div>
            
            <div class="payment-help">
                <div class="help-content">
                    <strong>ℹ️ Prestazioni Occasionali:</strong>
                    Ritenuta IRPEF del 20% applicata su compensi superiori a €25,82. 
                    Soglia annua €5.000 per persona fisica.
                </div>
            </div>
            
            <div class="payment-list" id="listOccasionale">
                <!-- Populated by JavaScript -->
            </div>
        </div>

        <!-- Partite IVA Tab -->
        <div class="tab-content" id="tabContentPartitaiva">
            <div class="tab-header">
                <h3>🏢 Partite IVA</h3>
                <div class="tab-actions">
                    <button class="btn btn-sm btn-outline" onclick="checkAllInvoices()">
                        📧 Verifica Fatture
                    </button>
                    <button class="btn btn-sm btn-warning" onclick="markAllInvoicesReceived()">
                        ✅ Conferma Tutte Ricevute
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="generateInvoiceReminders()">
                        📬 Genera Solleciti
                    </button>
                </div>
            </div>
            
            <div class="payment-help">
                <div class="help-content">
                    <strong>ℹ️ Partite IVA:</strong>
                    Nessuna ritenuta applicata. Fattura obbligatoria prima del pagamento.
                    Verificare dati fattura e IBAN prima dell'approvazione.
                </div>
            </div>
            
            <div class="payment-list" id="listPartitaIva">
                <!-- Populated by JavaScript -->
            </div>
        </div>

        <!-- Dipendenti Tab -->
        <div class="tab-content" id="tabContentDipendenti">
            <div class="tab-header">
                <h3>👔 Dipendenti e Contratti a Chiamata</h3>
                <div class="tab-actions">
                    <button class="btn btn-sm btn-primary" onclick="generatePayrollExport()">
                        📤 Export Buste Paga
                    </button>
                    <button class="btn btn-sm btn-outline" onclick="calculateContributions()">
                        🧮 Calcola Contributi
                    </button>
                </div>
            </div>
            
            <div class="payment-help">
                <div class="help-content">
                    <strong>ℹ️ Dipendenti:</strong>
                    Gestione attraverso sistema paghe. IRPEF e contributi INPS calcolati automaticamente.
                    I pagamenti vengono elaborati tramite cedolino mensile.
                </div>
            </div>
            
            <div class="payment-list" id="listDipendenti">
                <!-- Populated by JavaScript -->
            </div>
        </div>

        <!-- CIV Bancari Tab -->
        <div class="tab-content" id="tabContentCiv">
            <div class="tab-header">
                <h3>🏦 Generazione CIV Bancari</h3>
                <div class="tab-actions">
                    <select id="selectBanca" class="form-select">
                        <option value="">Seleziona Banca</option>
                        <option value="intesa">Intesa Sanpaolo</option>
                        <option value="unicredit">UniCredit</option>
                        <option value="bnl">BNL</option>
                        <option value="monte_paschi">Monte dei Paschi</option>
                        <option value="banco_bpm">Banco BPM</option>
                        <option value="generic">Formato Generico</option>
                    </select>
                    <button class="btn btn-sm btn-success" onclick="generateAdvancedCIV()">
                        📤 Genera CIV
                    </button>
                </div>
            </div>
            
            <div class="civ-preview">
                <div class="civ-summary">
                    <div class="summary-item">
                        <span class="summary-label">Beneficiari:</span>
                        <span class="summary-value" id="civNumBeneficiari">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Totale Lordo:</span>
                        <span class="summary-value" id="civTotaleLordo">€0,00</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Ritenute:</span>
                        <span class="summary-value" id="civTotaleRitenute">€0,00</span>
                    </div>
                    <div class="summary-item total">
                        <span class="summary-label">Totale Netto:</span>
                        <span class="summary-value" id="civTotaleNetto">€0,00</span>
                    </div>
                </div>
                
                <div class="civ-preview-list" id="civPreviewList">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Audit Tab -->
        <div class="tab-content" id="tabContentAudit">
            <div class="tab-header">
                <h3>📋 Audit Trail e Log Sistema</h3>
                <div class="tab-actions">
                    <button class="btn btn-sm btn-outline" onclick="exportAuditLog()">
                        📤 Export Log
                    </button>
                    <button class="btn btn-sm btn-warning" onclick="clearOldLogs()">
                        🗑️ Pulisci Log Vecchi
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="showPaymentHistory()">
                        📈 Storico Pagamenti
                    </button>
                </div>
            </div>
            
            <div class="audit-summary">
                <div class="recent-activity">
                    <h4>🕒 Attività Recenti</h4>
                    <div id="recentActivityList" class="activity-list">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    
    <!-- Advanced Payment Detail Modal -->
    <div id="advancedPaymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>💰 Dettaglio Pagamento</h3>
                <span class="close" onclick="closeAdvancedPaymentModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="paymentDetailContent">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAdvancedPaymentModal()">Chiudi</button>
            </div>
        </div>
    </div>

    <!-- IBAN Configuration Modal -->
    <div id="ibanConfigModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>🏦 Configurazione IBAN</h3>
                <span class="close" onclick="closeIbanConfigModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="ibanConfigForm">
                    <div class="form-group">
                        <label for="artistName">Artista</label>
                        <input type="text" id="artistName" readonly>
                    </div>
                    <div class="form-group">
                        <label for="newIban">IBAN</label>
                        <input type="text" id="newIban" placeholder="IT60 X054 2811 1010 0000 0123 456" required>
                    </div>
                    <div class="form-group">
                        <label for="intestatarioConto">Intestatario</label>
                        <input type="text" id="intestatarioConto" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeIbanConfigModal()">Annulla</button>
                <button class="btn btn-primary" onclick="saveIbanConfiguration()">Salva</button>
            </div>
        </div>
    </div>

    <!-- Payment Settings Modal -->
    <div id="paymentSettingsModal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h3>⚙️ Impostazioni Sistema Pagamenti</h3>
                <span class="close" onclick="closePaymentSettingsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="settings-tabs">
                    <div class="settings-tab active" onclick="showSettingsTab('general')">Generale</div>
                    <div class="settings-tab" onclick="showSettingsTab('ritenute')">Ritenute</div>
                    <div class="settings-tab" onclick="showSettingsTab('approvazioni')">Approvazioni</div>
                    <div class="settings-tab" onclick="showSettingsTab('banche')">Banche</div>
                </div>
                
                <div class="settings-content">
                    <div class="settings-section">
                        <h4>💰 Ritenute e Soglie</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Ritenuta Prestazioni Occasionali (%)</label>
                                <input type="number" value="20" min="0" max="100" step="0.1">
                            </div>
                            <div class="form-group">
                                <label>Soglia Ritenuta (€)</label>
                                <input type="number" value="25.82" min="0" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>Soglia Annua Occasionale (€)</label>
                                <input type="number" value="5000" min="0" step="1">
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h4>✅ Approvazioni Automatiche</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Approvazione Automatica Sotto (€)</label>
                                <input type="number" value="100" min="0" step="1">
                            </div>
                            <div class="form-group">
                                <label>Approvazione Dirigenziale Sopra (€)</label>
                                <input type="number" value="500" min="0" step="1">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePaymentSettingsModal()">Annulla</button>
                <button class="btn btn-primary" onclick="savePaymentSettings()">Salva Impostazioni</button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="main-footer">
        <div class="footer-content">
            <div class="company-info">
                <strong>OKL SRL - RECORP</strong><br>
                Via Monte Pasubio 222/1 - 36010 Zanè (VI)<br>
                P.IVA: 04433920248
            </div>
            <div class="footer-links">
                <a href="#privacy">Privacy Policy</a>
                <a href="#terms">Termini di Servizio</a>
                <a href="#cookies">Cookie Policy</a>
            </div>
            <div class="footer-copyright">
                © 2025 OKL SRL - Tutti i diritti riservati
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script type="module" src="../supabase-config.js"></script>
    <script type="module" src="../auth-guard.js"></script>
    <script type="module" src="./pagamenti.js"></script>
</body>
</html>